class CollectionsControllerTest < ActionController::TestCase
    describe "GET #show" do
        it "loads the correct collection on show" do
            @tester = User.find_by_email("abaker@element84.com")
            sign_in(@tester)

            get :show, id: 1, concept_id: "C1000000020-LANCEAMSR2"
            collection_records = assigns(:collection_records)
            assert_equal(collection_records.length, 1)
        end

        it "redirects when no concept id is provided" do
            #redirects no concept_id
            get :show, id: 1
            assert_equal(response.code, "302")
        end

        it "redirects when no collection is found" do
            #redirects no collection found
            get :show, id: 1, concept_id: "xyz"
            assert_equal(response.code, "302")
        end

    end


    describe "POST #create" do
        it "downloads and saves a new record" do
            @tester = User.find_by_email("abaker@element84.com")
            sign_in(@tester)

            stub_request(:get, "https://cmr.earthdata.nasa.gov/search/collections.echo10?concept_id=C222702-GHRC").with(:headers => {'Accept'=>'*/*', 'Accept-Encoding'=>'gzip;q=1.0,deflate;q=0.6,identity;q=0.3', 'User-Agent'=>'Ruby'}).to_return(:status => 200, :body => "<?xml version=\"1.0\" encoding=\"UTF-8\"?><results><hits>1</hits><took>2973</took><result concept-id=\"C222702-GHRC\" revision-id=\"32\" format=\"application/echo10+xml\"><Collection><ShortName>daylightn</ShortName><VersionId>1</VersionId><InsertTime>1988-01-01T00:00:00.000Z</InsertTime><LastUpdate>2012-01-07T14:34:28.000Z</LastUpdate><LongName>US COMPOSITE LIGHTNING DAILY TOTAL FROM NATL LIGHTNING NETWORK</LongName><DataSetId>US COMPOSITE LIGHTNING DAILY TOTAL FROM NATL LIGHTNING NETWORK V1</DataSetId><Description>The Global Hydrology Resource Center generates a cloud-to-ground lightning product from the data collected from the U.S. National Lightning Detection Network, a commercial lightning detection network operated by Global Atmospherics, Inc. (GAI), formerly Geomet Data Services. The daily products are produced by binning the number of flashes occurring in each pixel (pixel is approximately 8 km by 8 km) during a 24 hr period (00 UTC to 00 UTC). The data set begins on July 8, 1994 and continues through the present.</Description><Orderable>false</Orderable><Visible>true</Visible><ProcessingLevelId>3</ProcessingLevelId><ArchiveCenter>GHRC</ArchiveCenter><Price>0</Price><SpatialKeywords><Keyword>CONUS</Keyword></SpatialKeywords><TemporalKeywords><Keyword>DAILY TOTAL</Keyword></TemporalKeywords><Temporal><RangeDateTime><BeginningDateTime>1988-01-01T00:00:00.000Z</BeginningDateTime></RangeDateTime></Temporal><Contacts><Contact><Role>GHRC USER SERVICES</Role><OrganizationAddresses /><OrganizationPhones /><OrganizationEmails><Email>ghrc-dmg@itsc.uah.edu</Email></OrganizationEmails><ContactPersons /></Contact></Contacts><ScienceKeywords><ScienceKeyword><CategoryKeyword>EARTH SCIENCE</CategoryKeyword><TopicKeyword>ATMOSPHERE</TopicKeyword><TermKeyword>ATMOSPHERIC ELECTRICITY</TermKeyword><VariableLevel1Keyword><Value>LIGHTNING</Value></VariableLevel1Keyword></ScienceKeyword><ScienceKeyword><CategoryKeyword>EARTH SCIENCE</CategoryKeyword><TopicKeyword>ATMOSPHERE</TopicKeyword><TermKeyword>ATMOSPHERIC PHENOMENA</TermKeyword><VariableLevel1Keyword><Value>LIGHTNING</Value></VariableLevel1Keyword></ScienceKeyword></ScienceKeywords><Platforms><Platform><ShortName>NATIONAL LIGHTNING DETECTION NETWORK</ShortName><LongName>NATIONAL LIGHTNING DETECTION NETWORK</LongName><Type>GROUND BASED NETWORK</Type><Characteristics /><Instruments><Instrument><ShortName>RF ANTENNA</ShortName><Characteristics /><Sensors><Sensor><ShortName>RF ANTENNA</ShortName><Characteristics /></Sensor></Sensors><OperationModes /></Instrument></Instruments></Platform></Platforms><AdditionalAttributes /><CSDTDescriptions /><CollectionAssociations /><Campaigns><Campaign><ShortName>LIS</ShortName></Campaign></Campaigns><AlgorithmPackages /><TwoDCoordinateSystems /><OnlineAccessURLs /><OnlineResources><OnlineResource><URL>http://lightning.nsstc.nasa.gov/cgi-bin/nldn/nldn_cal.pl?1998+January</URL><Type>Browse</Type></OnlineResource><OnlineResource><URL>http://ghrc.nsstc.nasa.gov/uso/ds_docs/nldn/lightning_dataset.html</URL><Type>Guide</Type></OnlineResource><OnlineResource><URL>http://lightning.nsstc.nasa.gov/data/</URL><Type>Homepage</Type></OnlineResource></OnlineResources><AssociatedDIFs><DIF><EntryId>daylightn</EntryId></DIF></AssociatedDIFs><Spatial><SpatialCoverageType>Horizontal</SpatialCoverageType><HorizontalSpatialDomain><Geometry><CoordinateSystem>CARTESIAN</CoordinateSystem><BoundingRectangle><WestBoundingCoordinate>-130</WestBoundingCoordinate><NorthBoundingCoordinate>53</NorthBoundingCoordinate><EastBoundingCoordinate>-60</EastBoundingCoordinate><SouthBoundingCoordinate>20</SouthBoundingCoordinate></BoundingRectangle></Geometry></HorizontalSpatialDomain><GranuleSpatialRepresentation>CARTESIAN</GranuleSpatialRepresentation></Spatial></Collection></result></results>", :headers => {"date"=>["Tue, 21 Feb 2017 15:50:04 GMT"], "content-type"=>["application/echo10+xml; charset=utf-8"], "access-control-expose-headers"=>["CMR-Hits, CMR-Request-Id"], "access-control-allow-origin"=>["*"], "cmr-hits"=>["1"], "cmr-took"=>["2974"], "cmr-request-id"=>["bb005bac-18ce-4b6a-b69f-3f29f820ced5"], "vary"=>["Accept-Encoding, User-Agent"], "connection"=>["close"], "server"=>["Jetty(9.2.z-SNAPSHOT)"]})

            #Since a granule is chosen at random, a full mock can not be used.
            #in this instance, we return a set collection of results for any call using this concept id and granule keyword.
            stub_request(:get, /.*granules.*C222702-GHRC.*/).with(:headers => {'Accept'=>'*/*', 'Accept-Encoding'=>'gzip;q=1.0,deflate;q=0.6,identity;q=0.3', 'User-Agent'=>'Ruby'}).to_return(:status => 200, :body => "<?xml version=\"1.0\" encoding=\"UTF-8\"?><results><hits>10554</hits><took>39</took><result concept-id=\"G309203-GHRC\" collection-concept-id=\"C222702-GHRC\" revision-id=\"1\" format=\"application/echo10+xml\"><Granule><GranuleUR>Ndaily1988.003_cum_cglitn_v1.hdf</GranuleUR><InsertTime>2009-12-05T12:05:32.000Z</InsertTime><LastUpdate>2009-12-05T12:05:32.000Z</LastUpdate><Collection><ShortName>daylightn</ShortName><VersionId>1</VersionId></Collection><DataGranule><SizeMBDataGranule>0.402057647705078</SizeMBDataGranule><DayNightFlag>UNSPECIFIED</DayNightFlag><ProductionDateTime>2009-12-05T12:05:32.000Z</ProductionDateTime></DataGranule><Temporal><RangeDateTime><BeginningDateTime>1988-01-03T00:00:00.000Z</BeginningDateTime><EndingDateTime>1988-01-03T23:59:59.000Z</EndingDateTime></RangeDateTime></Temporal><Spatial><HorizontalSpatialDomain><Geometry><BoundingRectangle><WestBoundingCoordinate>-130</WestBoundingCoordinate><NorthBoundingCoordinate>53</NorthBoundingCoordinate><EastBoundingCoordinate>-60</EastBoundingCoordinate><SouthBoundingCoordinate>20</SouthBoundingCoordinate></BoundingRectangle></Geometry></HorizontalSpatialDomain></Spatial><Price>0</Price><OnlineResources><OnlineResource><URL>http://lightning.nsstc.nasa.gov/cgi-bin/nldn/nldn_cal.pl?1998+January</URL><Type>Browse</Type></OnlineResource><OnlineResource><URL>http://ghrc.nsstc.nasa.gov/uso/ds_docs/nldn/lightning_dataset.html</URL><Type>Guide</Type></OnlineResource><OnlineResource><URL>http://lightning.nsstc.nasa.gov/data/</URL><Type>Homepage</Type></OnlineResource></OnlineResources><Orderable>true</Orderable><DataFormat>HDF</DataFormat><Visible>true</Visible></Granule></result><result concept-id=\"G309204-GHRC\" collection-concept-id=\"C222702-GHRC\" revision-id=\"1\" format=\"application/echo10+xml\"><Granule><GranuleUR>Ndaily1988.004_cum_cglitn_v1.hdf</GranuleUR><InsertTime>2009-12-05T12:05:32.000Z</InsertTime><LastUpdate>2009-12-05T12:05:32.000Z</LastUpdate><Collection><ShortName>daylightn</ShortName><VersionId>1</VersionId></Collection><DataGranule><SizeMBDataGranule>0.402057647705078</SizeMBDataGranule><DayNightFlag>UNSPECIFIED</DayNightFlag><ProductionDateTime>2009-12-05T12:05:32.000Z</ProductionDateTime></DataGranule><Temporal><RangeDateTime><BeginningDateTime>1988-01-04T00:00:00.000Z</BeginningDateTime><EndingDateTime>1988-01-04T23:59:59.000Z</EndingDateTime></RangeDateTime></Temporal><Spatial><HorizontalSpatialDomain><Geometry><BoundingRectangle><WestBoundingCoordinate>-130</WestBoundingCoordinate><NorthBoundingCoordinate>53</NorthBoundingCoordinate><EastBoundingCoordinate>-60</EastBoundingCoordinate><SouthBoundingCoordinate>20</SouthBoundingCoordinate></BoundingRectangle></Geometry></HorizontalSpatialDomain></Spatial><Price>0</Price><OnlineResources><OnlineResource><URL>http://lightning.nsstc.nasa.gov/cgi-bin/nldn/nldn_cal.pl?1998+January</URL><Type>Browse</Type></OnlineResource><OnlineResource><URL>http://ghrc.nsstc.nasa.gov/uso/ds_docs/nldn/lightning_dataset.html</URL><Type>Guide</Type></OnlineResource><OnlineResource><URL>http://lightning.nsstc.nasa.gov/data/</URL><Type>Homepage</Type></OnlineResource></OnlineResources><Orderable>true</Orderable><DataFormat>HDF</DataFormat><Visible>true</Visible></Granule></result><result concept-id=\"G309205-GHRC\" collection-concept-id=\"C222702-GHRC\" revision-id=\"1\" format=\"application/echo10+xml\"><Granule><GranuleUR>Ndaily1988.005_cum_cglitn_v1.hdf</GranuleUR><InsertTime>2009-12-05T12:05:32.000Z</InsertTime><LastUpdate>2009-12-05T12:05:32.000Z</LastUpdate><Collection><ShortName>daylightn</ShortName><VersionId>1</VersionId></Collection><DataGranule><SizeMBDataGranule>0.402057647705078</SizeMBDataGranule><DayNightFlag>UNSPECIFIED</DayNightFlag><ProductionDateTime>2009-12-05T12:05:32.000Z</ProductionDateTime></DataGranule><Temporal><RangeDateTime><BeginningDateTime>1988-01-05T00:00:00.000Z</BeginningDateTime><EndingDateTime>1988-01-05T23:59:59.000Z</EndingDateTime></RangeDateTime></Temporal><Spatial><HorizontalSpatialDomain><Geometry><BoundingRectangle><WestBoundingCoordinate>-130</WestBoundingCoordinate><NorthBoundingCoordinate>53</NorthBoundingCoordinate><EastBoundingCoordinate>-60</EastBoundingCoordinate><SouthBoundingCoordinate>20</SouthBoundingCoordinate></BoundingRectangle></Geometry></HorizontalSpatialDomain></Spatial><Price>0</Price><OnlineResources><OnlineResource><URL>http://lightning.nsstc.nasa.gov/cgi-bin/nldn/nldn_cal.pl?1998+January</URL><Type>Browse</Type></OnlineResource><OnlineResource><URL>http://ghrc.nsstc.nasa.gov/uso/ds_docs/nldn/lightning_dataset.html</URL><Type>Guide</Type></OnlineResource><OnlineResource><URL>http://lightning.nsstc.nasa.gov/data/</URL><Type>Homepage</Type></OnlineResource></OnlineResources><Orderable>true</Orderable><DataFormat>HDF</DataFormat><Visible>true</Visible></Granule></result><result concept-id=\"G309206-GHRC\" collection-concept-id=\"C222702-GHRC\" revision-id=\"1\" format=\"application/echo10+xml\"><Granule><GranuleUR>Ndaily1988.006_cum_cglitn_v1.hdf</GranuleUR><InsertTime>2009-12-05T12:05:32.000Z</InsertTime><LastUpdate>2009-12-05T12:05:32.000Z</LastUpdate><Collection><ShortName>daylightn</ShortName><VersionId>1</VersionId></Collection><DataGranule><SizeMBDataGranule>0.402057647705078</SizeMBDataGranule><DayNightFlag>UNSPECIFIED</DayNightFlag><ProductionDateTime>2009-12-05T12:05:32.000Z</ProductionDateTime></DataGranule><Temporal><RangeDateTime><BeginningDateTime>1988-01-06T00:00:00.000Z</BeginningDateTime><EndingDateTime>1988-01-06T23:59:59.000Z</EndingDateTime></RangeDateTime></Temporal><Spatial><HorizontalSpatialDomain><Geometry><BoundingRectangle><WestBoundingCoordinate>-130</WestBoundingCoordinate><NorthBoundingCoordinate>53</NorthBoundingCoordinate><EastBoundingCoordinate>-60</EastBoundingCoordinate><SouthBoundingCoordinate>20</SouthBoundingCoordinate></BoundingRectangle></Geometry></HorizontalSpatialDomain></Spatial><Price>0</Price><OnlineResources><OnlineResource><URL>http://lightning.nsstc.nasa.gov/cgi-bin/nldn/nldn_cal.pl?1998+January</URL><Type>Browse</Type></OnlineResource><OnlineResource><URL>http://ghrc.nsstc.nasa.gov/uso/ds_docs/nldn/lightning_dataset.html</URL><Type>Guide</Type></OnlineResource><OnlineResource><URL>http://lightning.nsstc.nasa.gov/data/</URL><Type>Homepage</Type></OnlineResource></OnlineResources><Orderable>true</Orderable><DataFormat>HDF</DataFormat><Visible>true</Visible></Granule></result><result concept-id=\"G309207-GHRC\" collection-concept-id=\"C222702-GHRC\" revision-id=\"1\" format=\"application/echo10+xml\"><Granule><GranuleUR>Ndaily1988.007_cum_cglitn_v1.hdf</GranuleUR><InsertTime>2009-12-05T12:05:32.000Z</InsertTime><LastUpdate>2009-12-05T12:05:32.000Z</LastUpdate><Collection><ShortName>daylightn</ShortName><VersionId>1</VersionId></Collection><DataGranule><SizeMBDataGranule>0.402057647705078</SizeMBDataGranule><DayNightFlag>UNSPECIFIED</DayNightFlag><ProductionDateTime>2009-12-05T12:05:32.000Z</ProductionDateTime></DataGranule><Temporal><RangeDateTime><BeginningDateTime>1988-01-07T00:00:00.000Z</BeginningDateTime><EndingDateTime>1988-01-07T23:59:59.000Z</EndingDateTime></RangeDateTime></Temporal><Spatial><HorizontalSpatialDomain><Geometry><BoundingRectangle><WestBoundingCoordinate>-130</WestBoundingCoordinate><NorthBoundingCoordinate>53</NorthBoundingCoordinate><EastBoundingCoordinate>-60</EastBoundingCoordinate><SouthBoundingCoordinate>20</SouthBoundingCoordinate></BoundingRectangle></Geometry></HorizontalSpatialDomain></Spatial><Price>0</Price><OnlineResources><OnlineResource><URL>http://lightning.nsstc.nasa.gov/cgi-bin/nldn/nldn_cal.pl?1998+January</URL><Type>Browse</Type></OnlineResource><OnlineResource><URL>http://ghrc.nsstc.nasa.gov/uso/ds_docs/nldn/lightning_dataset.html</URL><Type>Guide</Type></OnlineResource><OnlineResource><URL>http://lightning.nsstc.nasa.gov/data/</URL><Type>Homepage</Type></OnlineResource></OnlineResources><Orderable>true</Orderable><DataFormat>HDF</DataFormat><Visible>true</Visible></Granule></result><result concept-id=\"G309208-GHRC\" collection-concept-id=\"C222702-GHRC\" revision-id=\"1\" format=\"application/echo10+xml\"><Granule><GranuleUR>Ndaily1988.008_cum_cglitn_v1.hdf</GranuleUR><InsertTime>2009-12-05T12:05:32.000Z</InsertTime><LastUpdate>2009-12-05T12:05:32.000Z</LastUpdate><Collection><ShortName>daylightn</ShortName><VersionId>1</VersionId></Collection><DataGranule><SizeMBDataGranule>0.402057647705078</SizeMBDataGranule><DayNightFlag>UNSPECIFIED</DayNightFlag><ProductionDateTime>2009-12-05T12:05:32.000Z</ProductionDateTime></DataGranule><Temporal><RangeDateTime><BeginningDateTime>1988-01-08T00:00:00.000Z</BeginningDateTime><EndingDateTime>1988-01-08T23:59:59.000Z</EndingDateTime></RangeDateTime></Temporal><Spatial><HorizontalSpatialDomain><Geometry><BoundingRectangle><WestBoundingCoordinate>-130</WestBoundingCoordinate><NorthBoundingCoordinate>53</NorthBoundingCoordinate><EastBoundingCoordinate>-60</EastBoundingCoordinate><SouthBoundingCoordinate>20</SouthBoundingCoordinate></BoundingRectangle></Geometry></HorizontalSpatialDomain></Spatial><Price>0</Price><OnlineResources><OnlineResource><URL>http://lightning.nsstc.nasa.gov/cgi-bin/nldn/nldn_cal.pl?1998+January</URL><Type>Browse</Type></OnlineResource><OnlineResource><URL>http://ghrc.nsstc.nasa.gov/uso/ds_docs/nldn/lightning_dataset.html</URL><Type>Guide</Type></OnlineResource><OnlineResource><URL>http://lightning.nsstc.nasa.gov/data/</URL><Type>Homepage</Type></OnlineResource></OnlineResources><Orderable>true</Orderable><DataFormat>HDF</DataFormat><Visible>true</Visible></Granule></result><result concept-id=\"G309209-GHRC\" collection-concept-id=\"C222702-GHRC\" revision-id=\"1\" format=\"application/echo10+xml\"><Granule><GranuleUR>Ndaily1988.009_cum_cglitn_v1.hdf</GranuleUR><InsertTime>2009-12-05T12:05:32.000Z</InsertTime><LastUpdate>2009-12-05T12:05:32.000Z</LastUpdate><Collection><ShortName>daylightn</ShortName><VersionId>1</VersionId></Collection><DataGranule><SizeMBDataGranule>0.402057647705078</SizeMBDataGranule><DayNightFlag>UNSPECIFIED</DayNightFlag><ProductionDateTime>2009-12-05T12:05:32.000Z</ProductionDateTime></DataGranule><Temporal><RangeDateTime><BeginningDateTime>1988-01-09T00:00:00.000Z</BeginningDateTime><EndingDateTime>1988-01-09T23:59:59.000Z</EndingDateTime></RangeDateTime></Temporal><Spatial><HorizontalSpatialDomain><Geometry><BoundingRectangle><WestBoundingCoordinate>-130</WestBoundingCoordinate><NorthBoundingCoordinate>53</NorthBoundingCoordinate><EastBoundingCoordinate>-60</EastBoundingCoordinate><SouthBoundingCoordinate>20</SouthBoundingCoordinate></BoundingRectangle></Geometry></HorizontalSpatialDomain></Spatial><Price>0</Price><OnlineResources><OnlineResource><URL>http://lightning.nsstc.nasa.gov/cgi-bin/nldn/nldn_cal.pl?1998+January</URL><Type>Browse</Type></OnlineResource><OnlineResource><URL>http://ghrc.nsstc.nasa.gov/uso/ds_docs/nldn/lightning_dataset.html</URL><Type>Guide</Type></OnlineResource><OnlineResource><URL>http://lightning.nsstc.nasa.gov/data/</URL><Type>Homepage</Type></OnlineResource></OnlineResources><Orderable>true</Orderable><DataFormat>HDF</DataFormat><Visible>true</Visible></Granule></result><result concept-id=\"G309210-GHRC\" collection-concept-id=\"C222702-GHRC\" revision-id=\"1\" format=\"application/echo10+xml\"><Granule><GranuleUR>Ndaily1988.010_cum_cglitn_v1.hdf</GranuleUR><InsertTime>2009-12-05T12:05:32.000Z</InsertTime><LastUpdate>2009-12-05T12:05:32.000Z</LastUpdate><Collection><ShortName>daylightn</ShortName><VersionId>1</VersionId></Collection><DataGranule><SizeMBDataGranule>0.402057647705078</SizeMBDataGranule><DayNightFlag>UNSPECIFIED</DayNightFlag><ProductionDateTime>2009-12-05T12:05:32.000Z</ProductionDateTime></DataGranule><Temporal><RangeDateTime><BeginningDateTime>1988-01-10T00:00:00.000Z</BeginningDateTime><EndingDateTime>1988-01-10T23:59:59.000Z</EndingDateTime></RangeDateTime></Temporal><Spatial><HorizontalSpatialDomain><Geometry><BoundingRectangle><WestBoundingCoordinate>-130</WestBoundingCoordinate><NorthBoundingCoordinate>53</NorthBoundingCoordinate><EastBoundingCoordinate>-60</EastBoundingCoordinate><SouthBoundingCoordinate>20</SouthBoundingCoordinate></BoundingRectangle></Geometry></HorizontalSpatialDomain></Spatial><Price>0</Price><OnlineResources><OnlineResource><URL>http://lightning.nsstc.nasa.gov/cgi-bin/nldn/nldn_cal.pl?1998+January</URL><Type>Browse</Type></OnlineResource><OnlineResource><URL>http://ghrc.nsstc.nasa.gov/uso/ds_docs/nldn/lightning_dataset.html</URL><Type>Guide</Type></OnlineResource><OnlineResource><URL>http://lightning.nsstc.nasa.gov/data/</URL><Type>Homepage</Type></OnlineResource></OnlineResources><Orderable>true</Orderable><DataFormat>HDF</DataFormat><Visible>true</Visible></Granule></result><result concept-id=\"G309211-GHRC\" collection-concept-id=\"C222702-GHRC\" revision-id=\"1\" format=\"application/echo10+xml\"><Granule><GranuleUR>Ndaily1988.011_cum_cglitn_v1.hdf</GranuleUR><InsertTime>2009-12-05T12:05:32.000Z</InsertTime><LastUpdate>2009-12-05T12:05:32.000Z</LastUpdate><Collection><ShortName>daylightn</ShortName><VersionId>1</VersionId></Collection><DataGranule><SizeMBDataGranule>0.402057647705078</SizeMBDataGranule><DayNightFlag>UNSPECIFIED</DayNightFlag><ProductionDateTime>2009-12-05T12:05:32.000Z</ProductionDateTime></DataGranule><Temporal><RangeDateTime><BeginningDateTime>1988-01-11T00:00:00.000Z</BeginningDateTime><EndingDateTime>1988-01-11T23:59:59.000Z</EndingDateTime></RangeDateTime></Temporal><Spatial><HorizontalSpatialDomain><Geometry><BoundingRectangle><WestBoundingCoordinate>-130</WestBoundingCoordinate><NorthBoundingCoordinate>53</NorthBoundingCoordinate><EastBoundingCoordinate>-60</EastBoundingCoordinate><SouthBoundingCoordinate>20</SouthBoundingCoordinate></BoundingRectangle></Geometry></HorizontalSpatialDomain></Spatial><Price>0</Price><OnlineResources><OnlineResource><URL>http://lightning.nsstc.nasa.gov/cgi-bin/nldn/nldn_cal.pl?1998+January</URL><Type>Browse</Type></OnlineResource><OnlineResource><URL>http://ghrc.nsstc.nasa.gov/uso/ds_docs/nldn/lightning_dataset.html</URL><Type>Guide</Type></OnlineResource><OnlineResource><URL>http://lightning.nsstc.nasa.gov/data/</URL><Type>Homepage</Type></OnlineResource></OnlineResources><Orderable>true</Orderable><DataFormat>HDF</DataFormat><Visible>true</Visible></Granule></result><result concept-id=\"G309212-GHRC\" collection-concept-id=\"C222702-GHRC\" revision-id=\"1\" format=\"application/echo10+xml\"><Granule><GranuleUR>Ndaily1988.012_cum_cglitn_v1.hdf</GranuleUR><InsertTime>2009-12-05T12:05:32.000Z</InsertTime><LastUpdate>2009-12-05T12:05:32.000Z</LastUpdate><Collection><ShortName>daylightn</ShortName><VersionId>1</VersionId></Collection><DataGranule><SizeMBDataGranule>0.402057647705078</SizeMBDataGranule><DayNightFlag>UNSPECIFIED</DayNightFlag><ProductionDateTime>2009-12-05T12:05:32.000Z</ProductionDateTime></DataGranule><Temporal><RangeDateTime><BeginningDateTime>1988-01-12T00:00:00.000Z</BeginningDateTime><EndingDateTime>1988-01-12T23:59:59.000Z</EndingDateTime></RangeDateTime></Temporal><Spatial><HorizontalSpatialDomain><Geometry><BoundingRectangle><WestBoundingCoordinate>-130</WestBoundingCoordinate><NorthBoundingCoordinate>53</NorthBoundingCoordinate><EastBoundingCoordinate>-60</EastBoundingCoordinate><SouthBoundingCoordinate>20</SouthBoundingCoordinate></BoundingRectangle></Geometry></HorizontalSpatialDomain></Spatial><Price>0</Price><OnlineResources><OnlineResource><URL>http://lightning.nsstc.nasa.gov/cgi-bin/nldn/nldn_cal.pl?1998+January</URL><Type>Browse</Type></OnlineResource><OnlineResource><URL>http://ghrc.nsstc.nasa.gov/uso/ds_docs/nldn/lightning_dataset.html</URL><Type>Guide</Type></OnlineResource><OnlineResource><URL>http://lightning.nsstc.nasa.gov/data/</URL><Type>Homepage</Type></OnlineResource></OnlineResources><Orderable>true</Orderable><DataFormat>HDF</DataFormat><Visible>true</Visible></Granule></result></results>", :headers => {"date"=>["Tue, 21 Feb 2017 16:02:46 GMT"], "content-type"=>["application/echo10+xml; charset=utf-8"], "access-control-expose-headers"=>["CMR-Hits, CMR-Request-Id"], "access-control-allow-origin"=>["*"], "cmr-hits"=>["10554"], "cmr-took"=>["40"], "cmr-request-id"=>["5b0c8426-3a23-4025-a4d3-6d1c9024153a"], "vary"=>["Accept-Encoding, User-Agent"], "connection"=>["close"], "server"=>["Jetty(9.2.z-SNAPSHOT)"]})

            #Making sure record does not exist before ingest
            assert_equal((Collection.where concept_id: "C222702-GHRC").length, 0)

            post :create, concept_id: "C222702-GHRC", revision_id: "32", granulesCount: 1

            #redirects after creation
            assert_equal(response.code, "302")

            #collection with rawJSON saved in system
            assert_equal((Collection.where concept_id: "C222702-GHRC").length, 1)
            assert_equal((Collection.where concept_id: "C222702-GHRC").first.records.first.values["ShortName"], "daylightn")

            record = (Collection.where concept_id: "C222702-GHRC").first.records.first
            #script ran on new collection
            assert_equal(record.binary_script_values["InsertTime"], true)

            #ingest for collection logged
            assert_equal(record.ingest.user.email, "abaker@element84.com")

            #saves 1 associated granule
            assert_equal((Collection.where concept_id: "C222702-GHRC").first.granules.length, 1)
            assert_equal((Collection.where concept_id: "C222702-GHRC").first.granules.first.records.first.values["collection_concept_id"], "C222702-GHRC")

            granule_record = (Collection.where concept_id: "C222702-GHRC").first.granules.first.records.first
            #ingest for granule logged
            assert_equal(granule_record.ingest.user.email, "abaker@element84.com")
        end
    end
end