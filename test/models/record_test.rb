require 'test_helper'
require 'stub_data'
Dir[Rails.root.join('test/**/*.rb')].each { |f| require f }

class RecordTest < ActiveSupport::TestCase
  include Helpers::RecordHelpers
  include RecordHelper

  setup do
    @cmr_base_url = Cmr.get_cmr_base_url
  end

  describe "test remove_quotes_from_all_values" do
    it "successfully removes quotes in 3+ levels deep." do
      example = { foo: { bar: { value: 'my "value"', alpha: { beta: 'my "gamma"' } } } }
      assert_equal(example[:foo][:bar][:value], 'my "value"')
      assert_equal(example[:foo][:bar][:alpha][:beta], 'my "gamma"')
      remove_quotes_from_all_values!(example)
      assert_equal(example[:foo][:bar][:value], 'my value')
      assert_equal(example[:foo][:bar][:alpha][:beta], 'my gamma')
    end
  end


  describe "attribute accessor methods" do
    it "returns correct attribute information for a record" do
      record = Record.find_by id: 1
      #had to remove description from yaml, json strings allow characters not allowed in yaml
      assert_equal(record.collection?, true)
      assert_equal(record.granule?, false)
      assert_equal(record.long_name, "Test_Long_Name")
      assert_equal(record.short_name, "A2_DySno_NRT")
      assert_equal(record.status_string, "In Process")
      assert_equal(record.concept_id, "C1000000020-LANCEAMSR2")
      assert_equal(record.version_id, "0")
      assert_equal(record.ingested_by, "abaker@element84.com")
    end
  end

  describe "script_values && script_score" do
    it "adds script results and can return them on command" do
      record = Record.find_by id: 1

      stub_request(:get, "#{@cmr_base_url}/search/concepts/C1000000020-LANCEAMSR2.echo10").
        with(
          headers: {
            'Accept'=>'*/*',
            'Accept-Encoding'=>'gzip;q=1.0,deflate;q=0.6,identity;q=0.3',
            'User-Agent'=>'Ruby'
          }).
        to_return(status: 200, body: DEPENDENT_COLLECTION, headers: {})

      #stubbing all requests for raw_data
      stub_request(:get, "#{@cmr_base_url}/search/collections.echo10?concept_id=C1000000020-LANCEAMSR2").with(:headers => { 'Accept'=>'*/*', 'Accept-Encoding'=>'gzip;q=1.0,deflate;q=0.6,identity;q=0.3'}).to_return(:status => 200, :body => "<?xml version=\"1.0\" encoding=\"UTF-8\"?><results><hits>1</hits><took>14</took><result concept-id=\"C1000000020-LANCEAMSR2\" revision-id=\"8\" format=\"application/echo10+xml\">\n<Collection>\n<ShortName>A2_DySno_NRT</ShortName>\n<VersionId>0</VersionId>\n<InsertTime>2015-05-01T13:26:43Z</InsertTime>\n<LastUpdate>2015-09-14T13:26:43Z</LastUpdate>\n<LongName>NRT AMSR2 DAILY L3 GLOBAL SNOW WATER EQUIVALENT EASE-GRIDS</LongName>\n<DataSetId>NRT AMSR2 DAILY L3 GLOBAL SNOW WATER EQUIVALENT EASE-GRIDS V0</DataSetId>\n<Description>The Advanced Microwave Scanning Radiometer 2 (AMSR2) instrument on the Global Change Observation Mission - Water 1 (GCOM-W1) provides global passive microwave measurements of terrestrial, oceanic, and atmospheric parameters for the investigation of global water and energy cycles.  Near real-time (NRT) products are generated within 3 hours of the last observations in the file, by the Land Atmosphere Near real-time Capability for EOS (LANCE) at the AMSR Science Investigator-led Processing System (AMSR SIPS), which is collocated with the Global Hydrology Resource Center (GHRC) DAAC.  The GCOM-W1 AMSR2 Level-3 Snow Water Equivalent (SWE) data set contains snow water equivalent (SWE) data and quality assurance flags mapped to Northern and Southern Hemisphere 25 km Equal-Area Scalable Earth Grids (EASE-Grids).  Data are stored in HDF-EOS5 format and are available via HTTP from the EOSDIS LANCE system at https://lance.nsstc.nasa.gov/amsr2-science/data/level3/daysnow/R00/hdfeos5/.  If data latency is not a primary concern, please consider using science quality products.  Science products are created using the best available ancillary, calibration and ephemeris information.  Science quality products are an internally consistent, well-calibrated record of the Earth's geophysical properties to support science.  The AMSR SIPS plans to start producing initial AMSR2 standard science quality data products in late 2015 and they will be available from the NSIDC DAAC.  Notice: All LANCE AMSR2 data should be used with the understanding that these are preliminary products.  Cross calibration with AMSR-E products has not been performed.  As updates are made to the L1R data set, those changes will be reflected in this higher level product.</Description>\n<CollectionDataType>NEAR_REAL_TIME</CollectionDataType>\n<Orderable>false</Orderable>\n<Visible>true</Visible>\n<ProcessingLevelId>3</ProcessingLevelId>\n<ArchiveCenter>GHRC</ArchiveCenter>\n<CitationForExternalPublication>Tedesco, M., J. Jeyaratnam, and R. Kelly. 2015. NRT AMSR2 Daily L3 Global Snow Water Equivalent EASE-Grids [indicate subset used]. Dataset available online, [https://lance.nsstc.nasa.gov/amsr2-science/data/level3/daysnow/R00/hdfeos5/] from NASA LANCE AMSR2 at the GHRC DAAC Huntsville, Alabama, U.S.A. doi: http://dx.doi.org/10.5067/AMSR2/A2_DySno_NRT</CitationForExternalPublication><Price>0.0</Price><SpatialKeywords>\n<Keyword>GLOBAL</Keyword></SpatialKeywords><TemporalKeywords>\n<Keyword>DAILY</Keyword></TemporalKeywords><Temporal><RangeDateTime>\n<BeginningDateTime>2015-05-01T00:00:00Z</BeginningDateTime></RangeDateTime></Temporal><Contacts><Contact>\n<Role>GHRC USER SERVICES</Role><OrganizationEmails>\n<Email>ghrc-dmg@itsc.uah.edu</Email></OrganizationEmails></Contact></Contacts><ScienceKeywords><ScienceKeyword>\n<CategoryKeyword>EARTH SCIENCE</CategoryKeyword>\n<TopicKeyword>CRYOSPHERE</TopicKeyword>\n<TermKeyword>SNOW/ICE</TermKeyword><VariableLevel1Keyword>\n<Value>SNOW WATER EQUIVALENT</Value></VariableLevel1Keyword></ScienceKeyword><ScienceKeyword>\n<CategoryKeyword>EARTH SCIENCE</CategoryKeyword>\n<TopicKeyword>TERRESTRIAL HYDROSPHERE</TopicKeyword>\n<TermKeyword>SNOW/ICE</TermKeyword><VariableLevel1Keyword>\n<Value>SNOW WATER EQUIVALENT</Value></VariableLevel1Keyword></ScienceKeyword></ScienceKeywords><Platforms><Platform>\n<ShortName>GCOM-W1</ShortName>\n<LongName>GCOM-W1</LongName>\n<Type>SATELLITE</Type><Instruments><Instrument>\n<ShortName>AMSR2</ShortName><Sensors><Sensor>\n<ShortName>AMSR2</ShortName></Sensor></Sensors></Instrument></Instruments></Platform></Platforms>\n<AdditionalAttributes>\n<AdditionalAttribute>\n<Name>identifier_product_doi</Name>\n<DataType>STRING</DataType>\n<Description>product DOI</Description>\n<Value>10.5067/AMSR2/A2_DySno_NRT</Value>\n</AdditionalAttribute>\n<AdditionalAttribute>\n<Name>identifier_product_doi_authority</Name>\n<DataType>STRING</DataType>\n<Description>DOI authority</Description>\n<Value>http://dx.doi.org</Value>\n</AdditionalAttribute>\n</AdditionalAttributes>\n<Campaigns><Campaign>\n<ShortName>LANCE</ShortName></Campaign></Campaigns><OnlineAccessURLs><OnlineAccessURL>\n<URL>https://lance.nsstc.nasa.gov/amsr2-science/data/level3/daysnow/R00/hdfeos5/</URL><URLDescription></URLDescription><MimeType></MimeType></OnlineAccessURL></OnlineAccessURLs><OnlineResources><OnlineResource>\n<URL>https://lance.itsc.uah.edu/amsr2-science/data/level3/daysnow/R00/hdfeos5/</URL><Description></Description>\n<Type>Alternate Data Access</Type></OnlineResource><OnlineResource>\n<URL>https://lance.nsstc.nasa.gov/amsr2-science/browse_png/level3/daysnow/R00/</URL><Description></Description>\n<Type>Browse</Type></OnlineResource><OnlineResource>\n<URL>https://worldview.earthdata.nasa.gov/</URL><Description></Description>\n<Type>Worldview Imagery</Type></OnlineResource><OnlineResource>\n<URL>http://lance.nsstc.nasa.gov/</URL><Description></Description>\n<Type>Homepage</Type></OnlineResource><OnlineResource>\n<URL>http://lance.nsstc.nasa.gov/amsr2-science/doc/LANCE_A2_DySno_NRT_dataset.pdf</URL><Description></Description>\n<Type>Guide</Type></OnlineResource><OnlineResource>\n<URL>http://dx.doi.org/10.5067/AMSR2/A2_DySno_NRT</URL><Description></Description>\n<Type>DOI</Type></OnlineResource><OnlineResource>\n<URL>http://ghrc.nsstc.nasa.gov/uso/citation.html</URL><Description></Description>\n<Type>Citing GHRC Data</Type></OnlineResource></OnlineResources><AssociatedDIFs><DIF>\n<EntryId>A2_DySno_NRT</EntryId></DIF></AssociatedDIFs><Spatial><SpatialCoverageType>Horizontal</SpatialCoverageType><HorizontalSpatialDomain><Geometry>\n<CoordinateSystem>CARTESIAN</CoordinateSystem><BoundingRectangle>\n<WestBoundingCoordinate>-180</WestBoundingCoordinate>\n<NorthBoundingCoordinate>90</NorthBoundingCoordinate>\n<EastBoundingCoordinate>180</EastBoundingCoordinate>\n<SouthBoundingCoordinate>-90</SouthBoundingCoordinate></BoundingRectangle></Geometry></HorizontalSpatialDomain>\n<GranuleSpatialRepresentation>CARTESIAN</GranuleSpatialRepresentation></Spatial>\n<MetadataStandardName>ECHO</MetadataStandardName>\n<MetadataStandardVersion>10</MetadataStandardVersion>\n</Collection></result></results>", :headers => { "date"=>["Tue, 21 Feb 2017 16:02:46 GMT"], "content-type"=>["application/echo10+xml; charset=utf-8"], "access-control-expose-headers"=>["CMR-Hits, CMR-Request-Id"], "access-control-allow-origin"=>["*"], "cmr-hits"=>["10554"], "cmr-took"=>["40"], "cmr-request-id"=>["5b0c8426-3a23-4025-a4d3-6d1c9024153a"], "vary"=>["Accept-Encoding, User-Agent"], "connection"=>["close"], "server"=>["Jetty(9.2.z-SNAPSHOT)"] })

      stub_request(:post, "https://quarc.nasa-impact.net/validate").
        with(
          body: "{\"data\":{\"format\":\"echo-c\"},\"files\":{\"file\":{\"ShortName\":\"A2_DySno_NRT\",\"VersionId\":\"0\",\"InsertTime\":\"2015-05-01T13:26:43Z\",\"LastUpdate\":\"2015-09-14T13:26:43Z\",\"LongName\":\"NRT AMSR2 DAILY L3 GLOBAL SNOW WATER EQUIVALENT EASE-GRIDS\",\"DataSetId\":\"NRT AMSR2 DAILY L3 GLOBAL SNOW WATER EQUIVALENT EASE-GRIDS V0\",\"Description\":\"The Advanced Microwave Scanning Radiometer 2 (AMSR2) instrument on the Global Change Observation Mission - Water 1 (GCOM-W1) provides global passive microwave measurements of terrestrial, oceanic, and atmospheric parameters for the investigation of global water and energy cycles.  Near real-time (NRT) products are generated within 3 hours of the last observations in the file, by the Land Atmosphere Near real-time Capability for EOS (LANCE) at the AMSR Science Investigator-led Processing System (AMSR SIPS), which is collocated with the Global Hydrology Resource Center (GHRC) DAAC.  The GCOM-W1 AMSR2 Level-3 Snow Water Equivalent (SWE) data set contains snow water equivalent (SWE) data and quality assurance flags mapped to Northern and Southern Hemisphere 25 km Equal-Area Scalable Earth Grids (EASE-Grids).  Data are stored in HDF-EOS5 format and are available via HTTP from the EOSDIS LANCE system at https://lance.nsstc.nasa.gov/amsr2-science/data/level3/daysnow/R00/hdfeos5/.  If data latency is not a primary concern, please consider using science quality products.  Science products are created using the best available ancillary, calibration and ephemeris information.  Science quality products are an internally consistent, well-calibrated record of the Earth's geophysical properties to support science.  The AMSR SIPS plans to start producing initial AMSR2 standard science quality data products in late 2015 and they will be available from the NSIDC DAAC.  Notice: All LANCE AMSR2 data should be used with the understanding that these are preliminary products.  Cross calibration with AMSR-E products has not been performed.  As updates are made to the L1R data set, those changes will be reflected in this higher level product.\",\"CollectionDataType\":\"NEAR_REAL_TIME\",\"Orderable\":\"false\",\"Visible\":\"true\",\"ProcessingLevelId\":\"3\",\"ArchiveCenter\":\"GHRC\",\"CitationForExternalPublication\":\"Tedesco, M., J. Jeyaratnam, and R. Kelly. 2015. NRT AMSR2 Daily L3 Global Snow Water Equivalent EASE-Grids [indicate subset used]. Dataset available online, [https://lance.nsstc.nasa.gov/amsr2-science/data/level3/daysnow/R00/hdfeos5/] from NASA LANCE AMSR2 at the GHRC DAAC Huntsville, Alabama, U.S.A. doi: http://dx.doi.org/10.5067/AMSR2/A2_DySno_NRT\",\"Price\":\"0.0\",\"SpatialKeywords\":{\"Keyword\":\"GLOBAL\"},\"TemporalKeywords\":{\"Keyword\":\"DAILY\"},\"Temporal\":{\"RangeDateTime\":{\"BeginningDateTime\":\"2015-05-01T00:00:00Z\"}},\"Contacts\":{\"Contact\":{\"Role\":\"GHRC USER SERVICES\",\"OrganizationEmails\":{\"Email\":\"ghrc-dmg@itsc.uah.edu\"}}},\"ScienceKeywords\":{\"ScienceKeyword\":[{\"CategoryKeyword\":\"EARTH SCIENCE\",\"TopicKeyword\":\"CRYOSPHERE\",\"TermKeyword\":\"SNOW/ICE\",\"VariableLevel1Keyword\":{\"Value\":\"SNOW WATER EQUIVALENT\"}},{\"CategoryKeyword\":\"EARTH SCIENCE\",\"TopicKeyword\":\"TERRESTRIAL HYDROSPHERE\",\"TermKeyword\":\"SNOW/ICE\",\"VariableLevel1Keyword\":{\"Value\":\"SNOW WATER EQUIVALENT\"}}]},\"Platforms\":{\"Platform\":{\"ShortName\":\"GCOM-W1\",\"LongName\":\"GCOM-W1\",\"Type\":\"SATELLITE\",\"Instruments\":{\"Instrument\":{\"ShortName\":\"AMSR2\",\"Sensors\":{\"Sensor\":{\"ShortName\":\"AMSR2\"}}}}}},\"AdditionalAttributes\":{\"AdditionalAttribute\":[{\"Name\":\"identifier_product_doi\",\"DataType\":\"STRING\",\"Description\":\"product DOI\",\"Value\":\"10.5067/AMSR2/A2_DySno_NRT\"},{\"Name\":\"identifier_product_doi_authority\",\"DataType\":\"STRING\",\"Description\":\"DOI authority\",\"Value\":\"http://dx.doi.org\"}]},\"Campaigns\":{\"Campaign\":{\"ShortName\":\"LANCE\"}},\"OnlineAccessURLs\":{\"OnlineAccessURL\":{\"URL\":\"https://lance.nsstc.nasa.gov/amsr2-science/data/level3/daysnow/R00/hdfeos5/\"}},\"OnlineResources\":{\"OnlineResource\":[{\"URL\":\"https://lance.itsc.uah.edu/amsr2-science/data/level3/daysnow/R00/hdfeos5/\",\"Type\":\"Alternate Data Access\"},{\"URL\":\"https://lance.nsstc.nasa.gov/amsr2-science/browse_png/level3/daysnow/R00/\",\"Type\":\"Browse\"},{\"URL\":\"https://worldview.earthdata.nasa.gov/\",\"Type\":\"Worldview Imagery\"},{\"URL\":\"http://lance.nsstc.nasa.gov/\",\"Type\":\"Homepage\"},{\"URL\":\"http://lance.nsstc.nasa.gov/amsr2-science/doc/LANCE_A2_DySno_NRT_dataset.pdf\",\"Type\":\"Guide\"},{\"URL\":\"http://dx.doi.org/10.5067/AMSR2/A2_DySno_NRT\",\"Type\":\"DOI\"},{\"URL\":\"http://ghrc.nsstc.nasa.gov/uso/citation.html\",\"Type\":\"Citing GHRC Data\"}]},\"AssociatedDIFs\":{\"DIF\":{\"EntryId\":\"A2_DySno_NRT\"}},\"Spatial\":{\"SpatialCoverageType\":\"Horizontal\",\"HorizontalSpatialDomain\":{\"Geometry\":{\"CoordinateSystem\":\"CARTESIAN\",\"BoundingRectangle\":{\"WestBoundingCoordinate\":\"-180\",\"NorthBoundingCoordinate\":\"90\",\"EastBoundingCoordinate\":\"180\",\"SouthBoundingCoordinate\":\"-90\"}}},\"GranuleSpatialRepresentation\":\"CARTESIAN\"},\"MetadataStandardName\":\"ECHO\",\"MetadataStandardVersion\":\"10\"}}}",
          headers: {
            'Accept'=>'*/*',
            'Accept-Encoding'=>'gzip;q=1.0,deflate;q=0.6,identity;q=0.3',
            'Content-Type'=>'application/json',
            'User-Agent'=>'Faraday v1.4.1'
          }).
        to_return(status: 200, body: "{}", headers: {})

      record.create_script
      script_values = record.script_values
      assert_equal(script_values, { "LongName"=>"ok", "ShortName"=>"ok", "VersionId"=>"ok" })
    end
  end

  describe "bubble_map" do
    it "returns correct bubble map" do
      record = Record.find_by id: 1

      stub_request(:get, "#{@cmr_base_url}/search/concepts/C1000000020-LANCEAMSR2.echo10").
        with(
          headers: {
            'Accept'=>'*/*',
            'Accept-Encoding'=>'gzip;q=1.0,deflate;q=0.6,identity;q=0.3',
            'User-Agent'=>'Ruby'
          }).
        to_return(status: 200, body: DEPENDENT_COLLECTION, headers: {})

      #stubbing all requests for raw_data
      stub_request(:get, "#{@cmr_base_url}/search/collections.echo10?concept_id=C1000000020-LANCEAMSR2").with(:headers => { 'Accept'=>'*/*', 'Accept-Encoding'=>'gzip;q=1.0,deflate;q=0.6,identity;q=0.3' }).to_return(:status => 200, :body => "<?xml version=\"1.0\" encoding=\"UTF-8\"?><results><hits>1</hits><took>14</took><result concept-id=\"C1000000020-LANCEAMSR2\" revision-id=\"8\" format=\"application/echo10+xml\">\n<Collection>\n<ShortName>A2_DySno_NRT</ShortName>\n<VersionId>0</VersionId>\n<InsertTime>2015-05-01T13:26:43Z</InsertTime>\n<LastUpdate>2015-09-14T13:26:43Z</LastUpdate>\n<LongName>NRT AMSR2 DAILY L3 GLOBAL SNOW WATER EQUIVALENT EASE-GRIDS</LongName>\n<DataSetId>NRT AMSR2 DAILY L3 GLOBAL SNOW WATER EQUIVALENT EASE-GRIDS V0</DataSetId>\n<Description>The Advanced Microwave Scanning Radiometer 2 (AMSR2) instrument on the Global Change Observation Mission - Water 1 (GCOM-W1) provides global passive microwave measurements of terrestrial, oceanic, and atmospheric parameters for the investigation of global water and energy cycles.  Near real-time (NRT) products are generated within 3 hours of the last observations in the file, by the Land Atmosphere Near real-time Capability for EOS (LANCE) at the AMSR Science Investigator-led Processing System (AMSR SIPS), which is collocated with the Global Hydrology Resource Center (GHRC) DAAC.  The GCOM-W1 AMSR2 Level-3 Snow Water Equivalent (SWE) data set contains snow water equivalent (SWE) data and quality assurance flags mapped to Northern and Southern Hemisphere 25 km Equal-Area Scalable Earth Grids (EASE-Grids).  Data are stored in HDF-EOS5 format and are available via HTTP from the EOSDIS LANCE system at https://lance.nsstc.nasa.gov/amsr2-science/data/level3/daysnow/R00/hdfeos5/.  If data latency is not a primary concern, please consider using science quality products.  Science products are created using the best available ancillary, calibration and ephemeris information.  Science quality products are an internally consistent, well-calibrated record of the Earth's geophysical properties to support science.  The AMSR SIPS plans to start producing initial AMSR2 standard science quality data products in late 2015 and they will be available from the NSIDC DAAC.  Notice: All LANCE AMSR2 data should be used with the understanding that these are preliminary products.  Cross calibration with AMSR-E products has not been performed.  As updates are made to the L1R data set, those changes will be reflected in this higher level product.</Description>\n<CollectionDataType>NEAR_REAL_TIME</CollectionDataType>\n<Orderable>false</Orderable>\n<Visible>true</Visible>\n<ProcessingLevelId>3</ProcessingLevelId>\n<ArchiveCenter>GHRC</ArchiveCenter>\n<CitationForExternalPublication>Tedesco, M., J. Jeyaratnam, and R. Kelly. 2015. NRT AMSR2 Daily L3 Global Snow Water Equivalent EASE-Grids [indicate subset used]. Dataset available online, [https://lance.nsstc.nasa.gov/amsr2-science/data/level3/daysnow/R00/hdfeos5/] from NASA LANCE AMSR2 at the GHRC DAAC Huntsville, Alabama, U.S.A. doi: http://dx.doi.org/10.5067/AMSR2/A2_DySno_NRT</CitationForExternalPublication><Price>0.0</Price><SpatialKeywords>\n<Keyword>GLOBAL</Keyword></SpatialKeywords><TemporalKeywords>\n<Keyword>DAILY</Keyword></TemporalKeywords><Temporal><RangeDateTime>\n<BeginningDateTime>2015-05-01T00:00:00Z</BeginningDateTime></RangeDateTime></Temporal><Contacts><Contact>\n<Role>GHRC USER SERVICES</Role><OrganizationEmails>\n<Email>ghrc-dmg@itsc.uah.edu</Email></OrganizationEmails></Contact></Contacts><ScienceKeywords><ScienceKeyword>\n<CategoryKeyword>EARTH SCIENCE</CategoryKeyword>\n<TopicKeyword>CRYOSPHERE</TopicKeyword>\n<TermKeyword>SNOW/ICE</TermKeyword><VariableLevel1Keyword>\n<Value>SNOW WATER EQUIVALENT</Value></VariableLevel1Keyword></ScienceKeyword><ScienceKeyword>\n<CategoryKeyword>EARTH SCIENCE</CategoryKeyword>\n<TopicKeyword>TERRESTRIAL HYDROSPHERE</TopicKeyword>\n<TermKeyword>SNOW/ICE</TermKeyword><VariableLevel1Keyword>\n<Value>SNOW WATER EQUIVALENT</Value></VariableLevel1Keyword></ScienceKeyword></ScienceKeywords><Platforms><Platform>\n<ShortName>GCOM-W1</ShortName>\n<LongName>GCOM-W1</LongName>\n<Type>SATELLITE</Type><Instruments><Instrument>\n<ShortName>AMSR2</ShortName><Sensors><Sensor>\n<ShortName>AMSR2</ShortName></Sensor></Sensors></Instrument></Instruments></Platform></Platforms>\n<AdditionalAttributes>\n<AdditionalAttribute>\n<Name>identifier_product_doi</Name>\n<DataType>STRING</DataType>\n<Description>product DOI</Description>\n<Value>10.5067/AMSR2/A2_DySno_NRT</Value>\n</AdditionalAttribute>\n<AdditionalAttribute>\n<Name>identifier_product_doi_authority</Name>\n<DataType>STRING</DataType>\n<Description>DOI authority</Description>\n<Value>http://dx.doi.org</Value>\n</AdditionalAttribute>\n</AdditionalAttributes>\n<Campaigns><Campaign>\n<ShortName>LANCE</ShortName></Campaign></Campaigns><OnlineAccessURLs><OnlineAccessURL>\n<URL>https://lance.nsstc.nasa.gov/amsr2-science/data/level3/daysnow/R00/hdfeos5/</URL><URLDescription></URLDescription><MimeType></MimeType></OnlineAccessURL></OnlineAccessURLs><OnlineResources><OnlineResource>\n<URL>https://lance.itsc.uah.edu/amsr2-science/data/level3/daysnow/R00/hdfeos5/</URL><Description></Description>\n<Type>Alternate Data Access</Type></OnlineResource><OnlineResource>\n<URL>https://lance.nsstc.nasa.gov/amsr2-science/browse_png/level3/daysnow/R00/</URL><Description></Description>\n<Type>Browse</Type></OnlineResource><OnlineResource>\n<URL>https://worldview.earthdata.nasa.gov/</URL><Description></Description>\n<Type>Worldview Imagery</Type></OnlineResource><OnlineResource>\n<URL>http://lance.nsstc.nasa.gov/</URL><Description></Description>\n<Type>Homepage</Type></OnlineResource><OnlineResource>\n<URL>http://lance.nsstc.nasa.gov/amsr2-science/doc/LANCE_A2_DySno_NRT_dataset.pdf</URL><Description></Description>\n<Type>Guide</Type></OnlineResource><OnlineResource>\n<URL>http://dx.doi.org/10.5067/AMSR2/A2_DySno_NRT</URL><Description></Description>\n<Type>DOI</Type></OnlineResource><OnlineResource>\n<URL>http://ghrc.nsstc.nasa.gov/uso/citation.html</URL><Description></Description>\n<Type>Citing GHRC Data</Type></OnlineResource></OnlineResources><AssociatedDIFs><DIF>\n<EntryId>A2_DySno_NRT</EntryId></DIF></AssociatedDIFs><Spatial><SpatialCoverageType>Horizontal</SpatialCoverageType><HorizontalSpatialDomain><Geometry>\n<CoordinateSystem>CARTESIAN</CoordinateSystem><BoundingRectangle>\n<WestBoundingCoordinate>-180</WestBoundingCoordinate>\n<NorthBoundingCoordinate>90</NorthBoundingCoordinate>\n<EastBoundingCoordinate>180</EastBoundingCoordinate>\n<SouthBoundingCoordinate>-90</SouthBoundingCoordinate></BoundingRectangle></Geometry></HorizontalSpatialDomain>\n<GranuleSpatialRepresentation>CARTESIAN</GranuleSpatialRepresentation></Spatial>\n<MetadataStandardName>ECHO</MetadataStandardName>\n<MetadataStandardVersion>10</MetadataStandardVersion>\n</Collection></result></results>", :headers => { "date"=>["Tue, 21 Feb 2017 16:02:46 GMT"], "content-type"=>["application/echo10+xml; charset=utf-8"], "access-control-expose-headers"=>["CMR-Hits, CMR-Request-Id"], "access-control-allow-origin"=>["*"], "cmr-hits"=>["10554"], "cmr-took"=>["40"], "cmr-request-id"=>["5b0c8426-3a23-4025-a4d3-6d1c9024153a"], "vary"=>["Accept-Encoding, User-Agent"], "connection"=>["close"], "server"=>["Jetty(9.2.z-SNAPSHOT)"] })

      stub_request(:post, "https://quarc.nasa-impact.net/validate").
        with(
          body: "{\"data\":{\"format\":\"echo-c\"},\"files\":{\"file\":{\"ShortName\":\"A2_DySno_NRT\",\"VersionId\":\"0\",\"InsertTime\":\"2015-05-01T13:26:43Z\",\"LastUpdate\":\"2015-09-14T13:26:43Z\",\"LongName\":\"NRT AMSR2 DAILY L3 GLOBAL SNOW WATER EQUIVALENT EASE-GRIDS\",\"DataSetId\":\"NRT AMSR2 DAILY L3 GLOBAL SNOW WATER EQUIVALENT EASE-GRIDS V0\",\"Description\":\"The Advanced Microwave Scanning Radiometer 2 (AMSR2) instrument on the Global Change Observation Mission - Water 1 (GCOM-W1) provides global passive microwave measurements of terrestrial, oceanic, and atmospheric parameters for the investigation of global water and energy cycles.  Near real-time (NRT) products are generated within 3 hours of the last observations in the file, by the Land Atmosphere Near real-time Capability for EOS (LANCE) at the AMSR Science Investigator-led Processing System (AMSR SIPS), which is collocated with the Global Hydrology Resource Center (GHRC) DAAC.  The GCOM-W1 AMSR2 Level-3 Snow Water Equivalent (SWE) data set contains snow water equivalent (SWE) data and quality assurance flags mapped to Northern and Southern Hemisphere 25 km Equal-Area Scalable Earth Grids (EASE-Grids).  Data are stored in HDF-EOS5 format and are available via HTTP from the EOSDIS LANCE system at https://lance.nsstc.nasa.gov/amsr2-science/data/level3/daysnow/R00/hdfeos5/.  If data latency is not a primary concern, please consider using science quality products.  Science products are created using the best available ancillary, calibration and ephemeris information.  Science quality products are an internally consistent, well-calibrated record of the Earth's geophysical properties to support science.  The AMSR SIPS plans to start producing initial AMSR2 standard science quality data products in late 2015 and they will be available from the NSIDC DAAC.  Notice: All LANCE AMSR2 data should be used with the understanding that these are preliminary products.  Cross calibration with AMSR-E products has not been performed.  As updates are made to the L1R data set, those changes will be reflected in this higher level product.\",\"CollectionDataType\":\"NEAR_REAL_TIME\",\"Orderable\":\"false\",\"Visible\":\"true\",\"ProcessingLevelId\":\"3\",\"ArchiveCenter\":\"GHRC\",\"CitationForExternalPublication\":\"Tedesco, M., J. Jeyaratnam, and R. Kelly. 2015. NRT AMSR2 Daily L3 Global Snow Water Equivalent EASE-Grids [indicate subset used]. Dataset available online, [https://lance.nsstc.nasa.gov/amsr2-science/data/level3/daysnow/R00/hdfeos5/] from NASA LANCE AMSR2 at the GHRC DAAC Huntsville, Alabama, U.S.A. doi: http://dx.doi.org/10.5067/AMSR2/A2_DySno_NRT\",\"Price\":\"0.0\",\"SpatialKeywords\":{\"Keyword\":\"GLOBAL\"},\"TemporalKeywords\":{\"Keyword\":\"DAILY\"},\"Temporal\":{\"RangeDateTime\":{\"BeginningDateTime\":\"2015-05-01T00:00:00Z\"}},\"Contacts\":{\"Contact\":{\"Role\":\"GHRC USER SERVICES\",\"OrganizationEmails\":{\"Email\":\"ghrc-dmg@itsc.uah.edu\"}}},\"ScienceKeywords\":{\"ScienceKeyword\":[{\"CategoryKeyword\":\"EARTH SCIENCE\",\"TopicKeyword\":\"CRYOSPHERE\",\"TermKeyword\":\"SNOW/ICE\",\"VariableLevel1Keyword\":{\"Value\":\"SNOW WATER EQUIVALENT\"}},{\"CategoryKeyword\":\"EARTH SCIENCE\",\"TopicKeyword\":\"TERRESTRIAL HYDROSPHERE\",\"TermKeyword\":\"SNOW/ICE\",\"VariableLevel1Keyword\":{\"Value\":\"SNOW WATER EQUIVALENT\"}}]},\"Platforms\":{\"Platform\":{\"ShortName\":\"GCOM-W1\",\"LongName\":\"GCOM-W1\",\"Type\":\"SATELLITE\",\"Instruments\":{\"Instrument\":{\"ShortName\":\"AMSR2\",\"Sensors\":{\"Sensor\":{\"ShortName\":\"AMSR2\"}}}}}},\"AdditionalAttributes\":{\"AdditionalAttribute\":[{\"Name\":\"identifier_product_doi\",\"DataType\":\"STRING\",\"Description\":\"product DOI\",\"Value\":\"10.5067/AMSR2/A2_DySno_NRT\"},{\"Name\":\"identifier_product_doi_authority\",\"DataType\":\"STRING\",\"Description\":\"DOI authority\",\"Value\":\"http://dx.doi.org\"}]},\"Campaigns\":{\"Campaign\":{\"ShortName\":\"LANCE\"}},\"OnlineAccessURLs\":{\"OnlineAccessURL\":{\"URL\":\"https://lance.nsstc.nasa.gov/amsr2-science/data/level3/daysnow/R00/hdfeos5/\"}},\"OnlineResources\":{\"OnlineResource\":[{\"URL\":\"https://lance.itsc.uah.edu/amsr2-science/data/level3/daysnow/R00/hdfeos5/\",\"Type\":\"Alternate Data Access\"},{\"URL\":\"https://lance.nsstc.nasa.gov/amsr2-science/browse_png/level3/daysnow/R00/\",\"Type\":\"Browse\"},{\"URL\":\"https://worldview.earthdata.nasa.gov/\",\"Type\":\"Worldview Imagery\"},{\"URL\":\"http://lance.nsstc.nasa.gov/\",\"Type\":\"Homepage\"},{\"URL\":\"http://lance.nsstc.nasa.gov/amsr2-science/doc/LANCE_A2_DySno_NRT_dataset.pdf\",\"Type\":\"Guide\"},{\"URL\":\"http://dx.doi.org/10.5067/AMSR2/A2_DySno_NRT\",\"Type\":\"DOI\"},{\"URL\":\"http://ghrc.nsstc.nasa.gov/uso/citation.html\",\"Type\":\"Citing GHRC Data\"}]},\"AssociatedDIFs\":{\"DIF\":{\"EntryId\":\"A2_DySno_NRT\"}},\"Spatial\":{\"SpatialCoverageType\":\"Horizontal\",\"HorizontalSpatialDomain\":{\"Geometry\":{\"CoordinateSystem\":\"CARTESIAN\",\"BoundingRectangle\":{\"WestBoundingCoordinate\":\"-180\",\"NorthBoundingCoordinate\":\"90\",\"EastBoundingCoordinate\":\"180\",\"SouthBoundingCoordinate\":\"-90\"}}},\"GranuleSpatialRepresentation\":\"CARTESIAN\"},\"MetadataStandardName\":\"ECHO\",\"MetadataStandardVersion\":\"10\"}}}",
          headers: {
            'Accept'=>'*/*',
            'Accept-Encoding'=>'gzip;q=1.0,deflate;q=0.6,identity;q=0.3',
            'Content-Type'=>'application/json',
            'User-Agent'=>'Faraday v1.4.1'
          }).
        to_return(status: 200, body: "{}", headers: {})

      record.create_script

      expected = {
        "ShortName" => {
          field_name: "ShortName",
          color:      "red",
          script:     false,
          opinion:    false,
          feedback:   false
        },
        "LongName" => {
          field_name: "LongName",
          color:      "green",
          script:     false,
          opinion:    false,
          feedback:   false
        },
        "VersionId" => {
          field_name: "VersionId",
          color:      "white",
          script:     false,
          opinion:    true,
          feedback:   false
        }
      }
      assert_equal(expected, record.bubble_map)
    end
  end

  describe "color_coding_complete? && has_enough_reviews" do
    it "catches incomplete record reviews" do
      record = records(:first)
      assert_not(record.color_coding_complete?)
      assert_not(record.has_enough_reviews?)

      #testing again with only one color missing
      color_codes = record.get_colors
      color_codes.each_with_index do |(key, value), indexer|
        if indexer == 0
          color_codes[key] = "white"
        else
          color_codes[key] = "green"
        end
      end
      record.update_colors(color_codes)
      assert_not(record.color_coding_complete?)

      #testing again with 1 review, 2 needed
      first_review = record.add_review(1)
      first_review.mark_complete
      assert_not(record.has_enough_reviews?)

      opinion_values = record.get_opinions
      opinion_values["ShortName"] = true
      record.update_opinions(opinion_values)
      assert_not(record.no_second_opinions?)
    end

    it "accepts complete reviews" do
      record = Record.find_by id: 1
      color_codes = record.color_codes
      color_codes.each do |key, value|
        color_codes[key] = "yellow"
      end

      record.update_colors(color_codes)
      #need to reload so the related recordData objects are updated.
      record.reload
      assert_equal(record.color_coding_complete?, true)


      first_review = record.add_review(1)
      first_review.mark_complete
      second_review = record.add_review(2)
      second_review.mark_complete
      assert_equal(record.has_enough_reviews?, true)

      opinion_values = record.get_opinions
      opinion_values["VersionId"] = false
      record.update_opinions(opinion_values)
      record.reload
      assert_equal(record.no_second_opinions?, true)
    end
  end

  describe "close" do

    it "closes a record and sets the closed at date" do
      record = records(:in_daac_review)
      record.close

      assert_equal(record.closed?, true)
      #testing that the time is not null and within range
      assert_equal((record.closed_date && (record.closed_date < DateTime.now) && (record.closed_date > (DateTime.now - 5000))), true)
      record.closed_date = "Tue, 28 Feb 2017 16:25:04 UTC +00:00"
      record.save
      record.reload
      assert_equal(record.formatted_closed_date, "02/28/2017 at 11:25AM")
    end

  end

  describe "evaluate_script" do
    it "returns results of the automated collection_script" do
      stub_request(:get, "https://cmr.sit.earthdata.nasa.gov/search/concepts/C1000000020-LANCEAMSR2.echo10").
        with(
          headers: {
            'Accept'=>'*/*',
            'Accept-Encoding'=>'gzip;q=1.0,deflate;q=0.6,identity;q=0.3',
            'User-Agent'=>'Ruby'
          }).
        to_return(status: 200, body: DEPENDENT_COLLECTION, headers: {})

      record = records(:first)
      raw_data = JSON.parse("{\"ShortName\":\"CIESIN_SEDAC_NRMI_NRPCHI15\",\"VersionId\":\"2015.00\",\"InsertTime\":\"2016-11-02T00:00:00.000Z\",\"LastUpdate\":\"2016-11-02T00:00:00.000Z\",\"LongName\":\"Natural Resource Protection and Child Health Indicators, 2015 Release\",\"DataSetId\":\"Natural Resource Protection and Child Health Indicators, 2015 Release\",\"Description\":\"The Natural Resource Protection and Child Health Indicators, 2015 Release, are produced in support of the U.S. Millennium Challenge Corporation as selection criteria for funding eligibility. These indicators are successors to the Natural Resource Management Index (NRMI), which was produced from 2006 to 2011 and was based on the same underlying data. Like the NRMI, the Natural Resource Protection Indicator (NRPI) and Child Health Indicator (CHI) are based on proximity-to-target scores ranging from 0 to 100 (at target). The NRPI covers 221 countries and is calculated based on the weighted average percentage of biomes under protected status. The CHI is a composite index for 188 countries derived from the average of three proximity-to-target scores for access to improved sanitation, access to improved water, and child mortality. The 2015 release includes a consistent time series of NRPIs and CHIs for 2010 to 2015.\",\"CollectionDataType\":\"SCIENCE_QUALITY\",\"Orderable\":\"true\",\"Visible\":\"true\",\"RevisionDate\":\"2016-11-02T00:00:00.000Z\",\"ArchiveCenter\":\"SEDAC\",\"CollectionState\":\"Completed\",\"SpatialKeywords\":{\"Keyword\":[\"AFRICA\",\"ALGERIA\",\"ASIA\",\"AUSTRALIA\",\"BHUTAN\",\"BOTSWANA\",\"BURMA\",\"CAMBODIA\",\"CAMEROON\",\"CANADA\",\"CAPE VERDE\",\"CAYMAN ISLANDS\",\"CENTRAL AFRICAN REPUBLIC\",\"CHAD\",\"CHILE\",\"CHINA\",\"COLOMBIA\",\"COMOROS\",\"CONGO\",\"CONGO, DEMOCRATIC REPUBLIC\",\"COOK ISLANDS\",\"COSTA RICA\",\"COTE D'IVOIRE\",\"CROATIA\",\"CUBA\",\"CURACAO\",\"CYPRUS\",\"CZECH REPUBLIC\",\"DENMARK\",\"DJIBOUTI\",\"DOMINICA\",\"DOMINICAN REPUBLIC\",\"ECUADOR\",\"EGYPT\",\"EL SALVADOR\",\"EQUATORIAL\",\"EQUATORIAL GUINEA\",\"ERITREA\",\"ESTONIA\",\"ETHIOPIA\",\"EUROPE\",\"FAEROE ISLANDS\",\"FALKLAND ISLANDS\",\"FIJI\",\"FINLAND\",\"FRANCE\",\"FRENCH GUIANA\",\"FRENCH POLYNESIA\",\"GABON\",\"GAMBIA\",\"GEORGIA\",\"GERMANY\",\"GHANA\",\"GIBRALTAR\",\"GLOBAL\",\"GREECE\",\"GREENLAND\",\"GRENADA\",\"GUADELOUPE\",\"GUAM\",\"GUATEMALA\",\"GUINEA\",\"GUINEA-BISSAU\",\"GUYANA\",\"HAITI\",\"HONDURAS\",\"HONG KONG\",\"HUNGARY\",\"ICELAND\",\"INDIA\",\"INDONESIA\",\"IRAN\",\"IRAQ\",\"IRELAND\",\"ISLE OF MAN\",\"ISRAEL\",\"ITALY\",\"JAMAICA\",\"JAPAN\",\"JORDAN\",\"KAZAKHSTAN\",\"KENYA\",\"KIRIBATI\",\"KOSOVO\",\"KUWAIT\",\"KYRGYZSTAN\",\"LAO PEOPLE'S DEMOCRATIC REPUBLIC\",\"LATVIA\",\"LEBANON\",\"LESOTHO\",\"LIBERIA\",\"LIBYA\",\"LIECHTENSTEIN\",\"LITHUANIA\",\"LUXEMBOURG\",\"MACAU\",\"MACEDONIA\",\"MADAGASCAR\",\"MALAWI\",\"MALAYSIA\",\"MALDIVES\",\"MALI\",\"MALTA\",\"MARSHALL ISLANDS\",\"MARTINIQUE\",\"MAURITANIA\",\"MAURITIUS\",\"MAYOTTE\",\"MEXICO\",\"MICRONESIA\",\"MID-LATITUDE\",\"MOLDOVA\",\"MONACO\",\"MONGOLIA\",\"MONTENEGRO\",\"MONTSERRAT\",\"MOROCCO\",\"MOZAMBIQUE\",\"NAMIBIA\",\"NAURU\",\"NEPAL\",\"NETHERLANDS\",\"NEW CALEDONIA\",\"NEW ZEALAND\",\"NICARAGUA\",\"NIGER\",\"NIGERIA\",\"NIUE\",\"NORFOLK ISLAND\",\"NORTH AMERICA\",\"NORTH KOREA\",\"NORTHERN MARIANA ISLANDS\",\"NORWAY\",\"OMAN\",\"PAKISTAN\",\"PALAU\",\"PALESTINE\",\"PANAMA\",\"PAPUA NEW GUINEA\",\"PARAGUAY\",\"PERU\",\"PHILIPPINES\",\"PITCAIRN ISLANDS\",\"POLAND\",\"POLAR\",\"PORTUGAL\",\"PUERTO RICO\",\"QATAR\",\"REUNION\",\"ROMANIA\",\"RUSSIAN FEDERATION\",\"RWANDA\",\"SAMOA\",\"SAN MARINO\",\"SAO TOME AND PRINCIPE\",\"SAUDI ARABIA\",\"SENEGAL\",\"SERBIA\",\"SEYCHELLES\",\"SIERRA LEONE\",\"SINGAPORE\",\"SLOVAKIA\",\"SLOVENIA\",\"SOLOMON ISLANDS\",\"SOMALIA\",\"SOUTH AFRICA\",\"SOUTH AMERICA\",\"SOUTH KOREA\",\"SOUTH SUDAN\",\"SPAIN\",\"SRI LANKA\",\"ST HELENA\",\"ST KITTS AND NEVIS\",\"ST LUCIA\",\"ST MAARTEN\",\"ST MARTIN\",\"ST PIERRE AND MIQUELON\",\"ST VINCENT AND THE GRENADINES\",\"SUDAN\",\"SURINAME\",\"SVALBARD AND JAN MAYEN\",\"SWAZILAND\",\"SWEDEN\",\"SWITZERLAND\",\"SYRIAN ARAB REPUBLIC\",\"TAIWAN\",\"TAJIKISTAN\",\"TANZANIA\",\"THAILAND\",\"TIMOR-LESTE\",\"TOGO\",\"TOKELAU\",\"TONGA\",\"TRINIDAD AND TOBAGO\",\"TUNISIA\",\"TURKEY\",\"TURKMENISTAN\",\"TURKS AND CAICOS ISLANDS\",\"TUVALU\",\"UGANDA\",\"UKRAINE\",\"UNITED KINGDOM\",\"UNITED STATES OF AMERICA\",\"URUGUAY\",\"UZBEKISTAN\",\"VANUATU\",\"VENEZUELA\",\"VIETNAM\",\"VIRGIN ISLANDS\",\"WALLIS AND FUTUNA ISLANDS\",\"WESTERN SAHARA\",\"YEMEN\",\"ZAMBIA\",\"ZIMBABWE\"]},\"Temporal\":{\"RangeDateTime\":{\"BeginningDateTime\":\"2010-01-01T00:00:00.000Z\",\"EndingDateTime\":\"2015-12-31T23:59:59.999Z\"}},\"Contacts\":{\"Contact\":[{\"Role\":\"METADATA AUTHOR\",\"OrganizationEmails\":{\"Email\":\"metadata@ciesin.columbia.edu\"},\"ContactPersons\":{\"ContactPerson\":{\"FirstName\":\"unknown\",\"LastName\":\"CIESIN METADATA ADMINISTRATION\"}}},{\"Role\":\"TECHNICAL CONTACT\",\"OrganizationEmails\":{\"Email\":\"ciesin.info@ciesin.columbia.edu\"},\"ContactPersons\":{\"ContactPerson\":{\"FirstName\":\"unknown\",\"LastName\":\"SEDAC USER SERVICES\"}}}]},\"ScienceKeywords\":{\"ScienceKeyword\":[{\"CategoryKeyword\":\"EARTH SCIENCE\",\"TopicKeyword\":\"BIOSPHERE\",\"TermKeyword\":\"ECOLOGICAL DYNAMICS\",\"VariableLevel1Keyword\":{\"Value\":\"COMMUNITY DYNAMICS\",\"VariableLevel2Keyword\":{\"Value\":\"BIODIVERSITY FUNCTIONS\"}}},{\"CategoryKeyword\":\"EARTH SCIENCE\",\"TopicKeyword\":\"BIOSPHERE\",\"TermKeyword\":\"ECOSYSTEMS\",\"VariableLevel1Keyword\":{\"Value\":\"TERRESTRIAL ECOSYSTEMS\",\"VariableLevel2Keyword\":{\"Value\":\"ALPINE/TUNDRA\",\"VariableLevel3Keyword\":\"ALPINE TUNDRA\"}}},{\"CategoryKeyword\":\"EARTH SCIENCE\",\"TopicKeyword\":\"BIOSPHERE\",\"TermKeyword\":\"ECOSYSTEMS\",\"VariableLevel1Keyword\":{\"Value\":\"TERRESTRIAL ECOSYSTEMS\",\"VariableLevel2Keyword\":{\"Value\":\"FORESTS\"}}},{\"CategoryKeyword\":\"EARTH SCIENCE\",\"TopicKeyword\":\"HUMAN DIMENSIONS\",\"TermKeyword\":\"ENVIRONMENTAL IMPACTS\",\"VariableLevel1Keyword\":{\"Value\":\"CONSERVATION\"}},{\"CategoryKeyword\":\"EARTH SCIENCE\",\"TopicKeyword\":\"HUMAN DIMENSIONS\",\"TermKeyword\":\"SUSTAINABILITY\",\"VariableLevel1Keyword\":{\"Value\":\"ENVIRONMENTAL SUSTAINABILITY\"}}]},\"Platforms\":{\"Platform\":{\"ShortName\":\"NOT APPLICABLE\",\"LongName\":null,\"Type\":\"Not applicable\",\"Instruments\":{\"Instrument\":{\"ShortName\":\"NOT APPLICABLE\"}}}},\"Campaigns\":{\"Campaign\":{\"ShortName\":\"NRMI\",\"LongName\":\"Natural Resources Management Index\"}},\"OnlineAccessURLs\":{\"OnlineAccessURL\":{\"URL\":\"http://sedac.ciesin.columbia.edu/data/set/nrmi-natural-resource-protection-child-health-indicators-2015/data-download\",\"URLDescription\":\"Data landing page\"}},\"Spatial\":{\"HorizontalSpatialDomain\":{\"Geometry\":{\"CoordinateSystem\":\"CARTESIAN\",\"BoundingRectangle\":{\"WestBoundingCoordinate\":\"-180\",\"NorthBoundingCoordinate\":\"90\",\"EastBoundingCoordinate\":\"180\",\"SouthBoundingCoordinate\":\"-55\"}}},\"GranuleSpatialRepresentation\":\"CARTESIAN\"}}")

      stub_request(:post, "https://quarc.nasa-impact.net/validate").
        with(
          body: "{\"data\":{\"format\":\"echo-c\"},\"files\":{\"file\":{\"ShortName\":\"CIESIN_SEDAC_NRMI_NRPCHI15\",\"VersionId\":\"2015.00\",\"InsertTime\":\"2016-11-02T00:00:00.000Z\",\"LastUpdate\":\"2016-11-02T00:00:00.000Z\",\"LongName\":\"Natural Resource Protection and Child Health Indicators, 2015 Release\",\"DataSetId\":\"Natural Resource Protection and Child Health Indicators, 2015 Release\",\"Description\":\"The Natural Resource Protection and Child Health Indicators, 2015 Release, are produced in support of the U.S. Millennium Challenge Corporation as selection criteria for funding eligibility. These indicators are successors to the Natural Resource Management Index (NRMI), which was produced from 2006 to 2011 and was based on the same underlying data. Like the NRMI, the Natural Resource Protection Indicator (NRPI) and Child Health Indicator (CHI) are based on proximity-to-target scores ranging from 0 to 100 (at target). The NRPI covers 221 countries and is calculated based on the weighted average percentage of biomes under protected status. The CHI is a composite index for 188 countries derived from the average of three proximity-to-target scores for access to improved sanitation, access to improved water, and child mortality. The 2015 release includes a consistent time series of NRPIs and CHIs for 2010 to 2015.\",\"CollectionDataType\":\"SCIENCE_QUALITY\",\"Orderable\":\"true\",\"Visible\":\"true\",\"RevisionDate\":\"2016-11-02T00:00:00.000Z\",\"ArchiveCenter\":\"SEDAC\",\"CollectionState\":\"Completed\",\"SpatialKeywords\":{\"Keyword\":[\"AFRICA\",\"ALGERIA\",\"ASIA\",\"AUSTRALIA\",\"BHUTAN\",\"BOTSWANA\",\"BURMA\",\"CAMBODIA\",\"CAMEROON\",\"CANADA\",\"CAPE VERDE\",\"CAYMAN ISLANDS\",\"CENTRAL AFRICAN REPUBLIC\",\"CHAD\",\"CHILE\",\"CHINA\",\"COLOMBIA\",\"COMOROS\",\"CONGO\",\"CONGO, DEMOCRATIC REPUBLIC\",\"COOK ISLANDS\",\"COSTA RICA\",\"COTE D'IVOIRE\",\"CROATIA\",\"CUBA\",\"CURACAO\",\"CYPRUS\",\"CZECH REPUBLIC\",\"DENMARK\",\"DJIBOUTI\",\"DOMINICA\",\"DOMINICAN REPUBLIC\",\"ECUADOR\",\"EGYPT\",\"EL SALVADOR\",\"EQUATORIAL\",\"EQUATORIAL GUINEA\",\"ERITREA\",\"ESTONIA\",\"ETHIOPIA\",\"EUROPE\",\"FAEROE ISLANDS\",\"FALKLAND ISLANDS\",\"FIJI\",\"FINLAND\",\"FRANCE\",\"FRENCH GUIANA\",\"FRENCH POLYNESIA\",\"GABON\",\"GAMBIA\",\"GEORGIA\",\"GERMANY\",\"GHANA\",\"GIBRALTAR\",\"GLOBAL\",\"GREECE\",\"GREENLAND\",\"GRENADA\",\"GUADELOUPE\",\"GUAM\",\"GUATEMALA\",\"GUINEA\",\"GUINEA-BISSAU\",\"GUYANA\",\"HAITI\",\"HONDURAS\",\"HONG KONG\",\"HUNGARY\",\"ICELAND\",\"INDIA\",\"INDONESIA\",\"IRAN\",\"IRAQ\",\"IRELAND\",\"ISLE OF MAN\",\"ISRAEL\",\"ITALY\",\"JAMAICA\",\"JAPAN\",\"JORDAN\",\"KAZAKHSTAN\",\"KENYA\",\"KIRIBATI\",\"KOSOVO\",\"KUWAIT\",\"KYRGYZSTAN\",\"LAO PEOPLE'S DEMOCRATIC REPUBLIC\",\"LATVIA\",\"LEBANON\",\"LESOTHO\",\"LIBERIA\",\"LIBYA\",\"LIECHTENSTEIN\",\"LITHUANIA\",\"LUXEMBOURG\",\"MACAU\",\"MACEDONIA\",\"MADAGASCAR\",\"MALAWI\",\"MALAYSIA\",\"MALDIVES\",\"MALI\",\"MALTA\",\"MARSHALL ISLANDS\",\"MARTINIQUE\",\"MAURITANIA\",\"MAURITIUS\",\"MAYOTTE\",\"MEXICO\",\"MICRONESIA\",\"MID-LATITUDE\",\"MOLDOVA\",\"MONACO\",\"MONGOLIA\",\"MONTENEGRO\",\"MONTSERRAT\",\"MOROCCO\",\"MOZAMBIQUE\",\"NAMIBIA\",\"NAURU\",\"NEPAL\",\"NETHERLANDS\",\"NEW CALEDONIA\",\"NEW ZEALAND\",\"NICARAGUA\",\"NIGER\",\"NIGERIA\",\"NIUE\",\"NORFOLK ISLAND\",\"NORTH AMERICA\",\"NORTH KOREA\",\"NORTHERN MARIANA ISLANDS\",\"NORWAY\",\"OMAN\",\"PAKISTAN\",\"PALAU\",\"PALESTINE\",\"PANAMA\",\"PAPUA NEW GUINEA\",\"PARAGUAY\",\"PERU\",\"PHILIPPINES\",\"PITCAIRN ISLANDS\",\"POLAND\",\"POLAR\",\"PORTUGAL\",\"PUERTO RICO\",\"QATAR\",\"REUNION\",\"ROMANIA\",\"RUSSIAN FEDERATION\",\"RWANDA\",\"SAMOA\",\"SAN MARINO\",\"SAO TOME AND PRINCIPE\",\"SAUDI ARABIA\",\"SENEGAL\",\"SERBIA\",\"SEYCHELLES\",\"SIERRA LEONE\",\"SINGAPORE\",\"SLOVAKIA\",\"SLOVENIA\",\"SOLOMON ISLANDS\",\"SOMALIA\",\"SOUTH AFRICA\",\"SOUTH AMERICA\",\"SOUTH KOREA\",\"SOUTH SUDAN\",\"SPAIN\",\"SRI LANKA\",\"ST HELENA\",\"ST KITTS AND NEVIS\",\"ST LUCIA\",\"ST MAARTEN\",\"ST MARTIN\",\"ST PIERRE AND MIQUELON\",\"ST VINCENT AND THE GRENADINES\",\"SUDAN\",\"SURINAME\",\"SVALBARD AND JAN MAYEN\",\"SWAZILAND\",\"SWEDEN\",\"SWITZERLAND\",\"SYRIAN ARAB REPUBLIC\",\"TAIWAN\",\"TAJIKISTAN\",\"TANZANIA\",\"THAILAND\",\"TIMOR-LESTE\",\"TOGO\",\"TOKELAU\",\"TONGA\",\"TRINIDAD AND TOBAGO\",\"TUNISIA\",\"TURKEY\",\"TURKMENISTAN\",\"TURKS AND CAICOS ISLANDS\",\"TUVALU\",\"UGANDA\",\"UKRAINE\",\"UNITED KINGDOM\",\"UNITED STATES OF AMERICA\",\"URUGUAY\",\"UZBEKISTAN\",\"VANUATU\",\"VENEZUELA\",\"VIETNAM\",\"VIRGIN ISLANDS\",\"WALLIS AND FUTUNA ISLANDS\",\"WESTERN SAHARA\",\"YEMEN\",\"ZAMBIA\",\"ZIMBABWE\"]},\"Temporal\":{\"RangeDateTime\":{\"BeginningDateTime\":\"2010-01-01T00:00:00.000Z\",\"EndingDateTime\":\"2015-12-31T23:59:59.999Z\"}},\"Contacts\":{\"Contact\":[{\"Role\":\"METADATA AUTHOR\",\"OrganizationEmails\":{\"Email\":\"metadata@ciesin.columbia.edu\"},\"ContactPersons\":{\"ContactPerson\":{\"FirstName\":\"unknown\",\"LastName\":\"CIESIN METADATA ADMINISTRATION\"}}},{\"Role\":\"TECHNICAL CONTACT\",\"OrganizationEmails\":{\"Email\":\"ciesin.info@ciesin.columbia.edu\"},\"ContactPersons\":{\"ContactPerson\":{\"FirstName\":\"unknown\",\"LastName\":\"SEDAC USER SERVICES\"}}}]},\"ScienceKeywords\":{\"ScienceKeyword\":[{\"CategoryKeyword\":\"EARTH SCIENCE\",\"TopicKeyword\":\"BIOSPHERE\",\"TermKeyword\":\"ECOLOGICAL DYNAMICS\",\"VariableLevel1Keyword\":{\"Value\":\"COMMUNITY DYNAMICS\",\"VariableLevel2Keyword\":{\"Value\":\"BIODIVERSITY FUNCTIONS\"}}},{\"CategoryKeyword\":\"EARTH SCIENCE\",\"TopicKeyword\":\"BIOSPHERE\",\"TermKeyword\":\"ECOSYSTEMS\",\"VariableLevel1Keyword\":{\"Value\":\"TERRESTRIAL ECOSYSTEMS\",\"VariableLevel2Keyword\":{\"Value\":\"ALPINE/TUNDRA\",\"VariableLevel3Keyword\":\"ALPINE TUNDRA\"}}},{\"CategoryKeyword\":\"EARTH SCIENCE\",\"TopicKeyword\":\"BIOSPHERE\",\"TermKeyword\":\"ECOSYSTEMS\",\"VariableLevel1Keyword\":{\"Value\":\"TERRESTRIAL ECOSYSTEMS\",\"VariableLevel2Keyword\":{\"Value\":\"FORESTS\"}}},{\"CategoryKeyword\":\"EARTH SCIENCE\",\"TopicKeyword\":\"HUMAN DIMENSIONS\",\"TermKeyword\":\"ENVIRONMENTAL IMPACTS\",\"VariableLevel1Keyword\":{\"Value\":\"CONSERVATION\"}},{\"CategoryKeyword\":\"EARTH SCIENCE\",\"TopicKeyword\":\"HUMAN DIMENSIONS\",\"TermKeyword\":\"SUSTAINABILITY\",\"VariableLevel1Keyword\":{\"Value\":\"ENVIRONMENTAL SUSTAINABILITY\"}}]},\"Platforms\":{\"Platform\":{\"ShortName\":\"NOT APPLICABLE\",\"LongName\":null,\"Type\":\"Not applicable\",\"Instruments\":{\"Instrument\":{\"ShortName\":\"NOT APPLICABLE\"}}}},\"Campaigns\":{\"Campaign\":{\"ShortName\":\"NRMI\",\"LongName\":\"Natural Resources Management Index\"}},\"OnlineAccessURLs\":{\"OnlineAccessURL\":{\"URL\":\"http://sedac.ciesin.columbia.edu/data/set/nrmi-natural-resource-protection-child-health-indicators-2015/data-download\",\"URLDescription\":\"Data landing page\"}},\"Spatial\":{\"HorizontalSpatialDomain\":{\"Geometry\":{\"CoordinateSystem\":\"CARTESIAN\",\"BoundingRectangle\":{\"WestBoundingCoordinate\":\"-180\",\"NorthBoundingCoordinate\":\"90\",\"EastBoundingCoordinate\":\"180\",\"SouthBoundingCoordinate\":\"-55\"}}},\"GranuleSpatialRepresentation\":\"CARTESIAN\"}}}}",
          headers: {
            'Accept'=>'*/*',
            'Accept-Encoding'=>'gzip;q=1.0,deflate;q=0.6,identity;q=0.3',
            'Content-Type'=>'application/json',
            'User-Agent'=>'Faraday v1.4.1'
          }).
        to_return(status: 200, body: "{}", headers: {})

      Quarc.stub_any_instance(:validate, {"AdditionalAttributes/AdditionalAttribute/DataType"=>"OK", "AdditionalAttributes/AdditionalAttribute/Value"=>"doi_link_update failed<br>", "ArchiveCenter"=>"<b>Errors:</b><ul><li>Error: The provided data center short name `GHRC` does not comply with the GCMD. </li> </ul><b>Remediation:</b><br>Please submit a request to support@earthdata.nasa.gov to have this provider added to the GCMD Providers KMS.", "Campaigns/Campaign/ShortName"=>"OK", "CitationforExternalPublication"=>"<b>Errors:</b><ul><li>Warning: No CitationforExternalPublication is provided.</li> </ul><b>Remediation:</b><br>Please provide a citation for the dataset in the CitationforExternalPublication field.", "CollectionDataType"=>"OK", "Contacts/Contact/Role"=>"<b>Errors:</b><ul><li>Error: `['GHRC USER SERVICES']` is not a valid Contact Role.</li> </ul><b>Remediation:</b><br>Select a Contact Role from the following list: ['ARCHIVER', 'DISTRIBUTOR', 'PROCESSOR', 'ORIGINATOR'].", "DOI/Explanation"=>"OK", "DataSetId"=>"OK", "Description"=>"OK", "InsertTime"=>"OK", "LastUpdate"=>"OK", "OnlineResources/OnlineResource/MimeType"=>"OK", "OnlineResources/OnlineResource/Type"=>"<b>Errors:</b><ul><li>Error: Online Resource Type `Alternate Data Access` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `Browse` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `Worldview Imagery` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `Homepage` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `Guide` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `DOI` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `Citing GHRC Data` is not consistent with GCMD 'rucontenttype' list.</li> </ul><b>Remediation:</b><br>Please provide a GCMD compliant Online Resource Type.", "Orderable"=>"OK", "Platforms/Platform/Characteristics/Characteristic/DataType"=>"OK", "Platforms/Platform/Characteristics/Characteristic/Description"=>"OK", "Platforms/Platform/Characteristics/Characteristic/Name"=>"OK", "Platforms/Platform/Characteristics/Characteristic/Unit"=>"OK", "Platforms/Platform/Characteristics/Characteristic/Value"=>"OK", "Platforms/Platform/Instruments/Instrument/Characteristics/Characteristic/DataType"=>"OK", "Platforms/Platform/Instruments/Instrument/Characteristics/Characteristic/Description"=>"OK", "Platforms/Platform/Instruments/Instrument/Characteristics/Characteristic/Name"=>"OK", "Platforms/Platform/Instruments/Instrument/Characteristics/Characteristic/Unit"=>"OK", "Platforms/Platform/Instruments/Instrument/Characteristics/Characteristic/Value"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/Characteristics/Characteristic/DataType"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/Characteristics/Characteristic/Description"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/Characteristics/Characteristic/Name"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/Characteristics/Characteristic/Unit"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/Characteristics/Characteristic/Value"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/ShortName"=>"OK", "Platforms/Platform/Instruments/Instrument/ShortName"=>"OK", "Platforms/Platform/LongName"=>"<b>Errors:</b><ul><li>Error: The provided platform long name `GCOM-W1` does not comply with the GCMD.</li> </ul><b>Remediation:</b><br>Please submit a request to support@earthdata.nasa.gov to have this platform added to the GCMD Platform KMS.", "Platforms/Platform/Type"=>"<b>Errors:</b><ul><li>Error: The provided platform type `SATELLITE` does not comply with the GCMD.</li> </ul><b>Remediation:</b><br>Please submit a request to support@earthdata.nasa.gov to have this platform type added to the GCMD Platforms KMS.", "ProcessingLevelId"=>"OK", "ScienceKeywords/ScienceKeyword/CategoryKeyword"=>"OK", "Spatial/GranuleSpatialRepresentation"=>"OK", "Spatial/HorizontalSpatialDomain/Geometry/CoordinateSystem"=>"<b>Errors:</b><ul><li>Error: Missing child element(s). Expected is one of ( Point, BoundingRectangle, GPolygon, Line ).</li> </ul>schema failed<br>", "Spatial/HorizontalSpatialDomain/Geometry/Point"=>"<b>Errors:</b><ul><li>Info: No spatial extent is provided.</li> </ul><b>Remediation:</b><br>Please provide a spatial extent in one of the following form: Point, Bounding Rectangle, GPolygon, Line", "Spatial/SpatialCoverageType"=>"<b>Errors:</b><ul><li>Error: The Spatial Coverage Type provided `['Horizontal']` is invalid.</li> </ul><b>Remediation:</b><br>Please provide a Spatial Coverage Type from the following list: ['HORIZONTAL', 'VERTICAL', 'ORBITAL', 'HORIZONTAL_VERTICAL', ORBITAL_VERTICAL', 'HORIZONTAL_ORBITAL', 'HORIZONTAL_VERTICAL_ORBITAL']", "SpatialInfo/HorizontalCoordinateSystem/GeodeticModel/HorizontalDatumName"=>"<b>Errors:</b><ul><li>Info: Horizontal Datum Name is missing.</li> </ul><b>Remediation:</b><br>Please provide a Horizontal Datum Name.", "SpatialKeywords/Keyword"=>"OK", "Temporal/EndsAtPresentFlag"=>"<b>Errors:</b><ul><li>Warning: Potential issue with:\n - No EndingDateTime provided; no EndsAtPresentFlag provided for a potentially active collection. \n - CollectionState is not \"COMPLETE\"; no EndsAtPresentFlag provided for a potentially active collection.</li> </ul><b>Remediation:</b><br>If data collection is ongoing, provide an EndsAtPresentFlag of \"true\"", "Temporal/RangeDateTime/BeginningDateTime"=>"OK", "Temporal/SingleDateTime"=>"OK", "UseConstraints"=>"<b>Errors:</b><ul><li>Warning: No license information is provided.</li> </ul><b>Remediation:</b><br>Please provide information about the license applicable to the dataset, preferably as a URL. For EOSDIS records, please providing the following link (unless under different usage terms): https://earthdata.nasa.gov/earth-observation-data/data-use-policy", "Visible"=>"OK"}) do
        comment_hash = record.evaluate_script(raw_data)
        comment_hash = sort_by_key(comment_hash)

        #URL is removed to prevent this test fails when it is broken link
        comment_hash.delete("OnlineAccessURLs/OnlineAccessURL/URL")
        comment_hash.delete("OnlineResources/OnlineResource/URL")

        expected = {"AdditionalAttributes/AdditionalAttribute/DataType"=>"OK", "AdditionalAttributes/AdditionalAttribute/Value"=>"doi_link_update failed<br>", "ArchiveCenter"=>"<b>Errors:</b><ul><li>Error: The provided data center short name `GHRC` does not comply with the GCMD. </li> </ul><b>Remediation:</b><br>Please submit a request to support@earthdata.nasa.gov to have this provider added to the GCMD Providers KMS.", "Campaigns/Campaign/ShortName"=>"OK", "CitationforExternalPublication"=>"<b>Errors:</b><ul><li>Warning: No CitationforExternalPublication is provided.</li> </ul><b>Remediation:</b><br>Please provide a citation for the dataset in the CitationforExternalPublication field.", "CollectionDataType"=>"OK", "Contacts/Contact/Role"=>"<b>Errors:</b><ul><li>Error: `['GHRC USER SERVICES']` is not a valid Contact Role.</li> </ul><b>Remediation:</b><br>Select a Contact Role from the following list: ['ARCHIVER', 'DISTRIBUTOR', 'PROCESSOR', 'ORIGINATOR'].", "DOI/Explanation"=>"OK", "DataSetId"=>"OK", "Description"=>"OK", "InsertTime"=>"OK", "LastUpdate"=>"OK", "OnlineResources/OnlineResource/MimeType"=>"OK", "OnlineResources/OnlineResource/Type"=>"<b>Errors:</b><ul><li>Error: Online Resource Type `Alternate Data Access` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `Browse` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `Worldview Imagery` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `Homepage` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `Guide` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `DOI` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `Citing GHRC Data` is not consistent with GCMD 'rucontenttype' list.</li> </ul><b>Remediation:</b><br>Please provide a GCMD compliant Online Resource Type.", "Orderable"=>"OK", "Platforms/Platform/Characteristics/Characteristic/DataType"=>"OK", "Platforms/Platform/Characteristics/Characteristic/Description"=>"OK", "Platforms/Platform/Characteristics/Characteristic/Name"=>"OK", "Platforms/Platform/Characteristics/Characteristic/Unit"=>"OK", "Platforms/Platform/Characteristics/Characteristic/Value"=>"OK", "Platforms/Platform/Instruments/Instrument/Characteristics/Characteristic/DataType"=>"OK", "Platforms/Platform/Instruments/Instrument/Characteristics/Characteristic/Description"=>"OK", "Platforms/Platform/Instruments/Instrument/Characteristics/Characteristic/Name"=>"OK", "Platforms/Platform/Instruments/Instrument/Characteristics/Characteristic/Unit"=>"OK", "Platforms/Platform/Instruments/Instrument/Characteristics/Characteristic/Value"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/Characteristics/Characteristic/DataType"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/Characteristics/Characteristic/Description"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/Characteristics/Characteristic/Name"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/Characteristics/Characteristic/Unit"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/Characteristics/Characteristic/Value"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/ShortName"=>"OK", "Platforms/Platform/Instruments/Instrument/ShortName"=>"OK", "Platforms/Platform/LongName"=>"<b>Errors:</b><ul><li>Error: The provided platform long name `GCOM-W1` does not comply with the GCMD.</li> </ul><b>Remediation:</b><br>Please submit a request to support@earthdata.nasa.gov to have this platform added to the GCMD Platform KMS.", "Platforms/Platform/Type"=>"<b>Errors:</b><ul><li>Error: The provided platform type `SATELLITE` does not comply with the GCMD.</li> </ul><b>Remediation:</b><br>Please submit a request to support@earthdata.nasa.gov to have this platform type added to the GCMD Platforms KMS.", "ProcessingLevelId"=>"OK", "ScienceKeywords/ScienceKeyword/CategoryKeyword"=>"OK", "Spatial/GranuleSpatialRepresentation"=>"OK", "Spatial/HorizontalSpatialDomain/Geometry/CoordinateSystem"=>"<b>Errors:</b><ul><li>Error: Missing child element(s). Expected is one of ( Point, BoundingRectangle, GPolygon, Line ).</li> </ul>schema failed<br>", "Spatial/HorizontalSpatialDomain/Geometry/Point"=>"<b>Errors:</b><ul><li>Info: No spatial extent is provided.</li> </ul><b>Remediation:</b><br>Please provide a spatial extent in one of the following form: Point, Bounding Rectangle, GPolygon, Line", "Spatial/SpatialCoverageType"=>"<b>Errors:</b><ul><li>Error: The Spatial Coverage Type provided `['Horizontal']` is invalid.</li> </ul><b>Remediation:</b><br>Please provide a Spatial Coverage Type from the following list: ['HORIZONTAL', 'VERTICAL', 'ORBITAL', 'HORIZONTAL_VERTICAL', ORBITAL_VERTICAL', 'HORIZONTAL_ORBITAL', 'HORIZONTAL_VERTICAL_ORBITAL']", "SpatialInfo/HorizontalCoordinateSystem/GeodeticModel/HorizontalDatumName"=>"<b>Errors:</b><ul><li>Info: Horizontal Datum Name is missing.</li> </ul><b>Remediation:</b><br>Please provide a Horizontal Datum Name.", "SpatialKeywords/Keyword"=>"OK", "Temporal/EndsAtPresentFlag"=>"<b>Errors:</b><ul><li>Warning: Potential issue with:\n - No EndingDateTime provided; no EndsAtPresentFlag provided for a potentially active collection. \n - CollectionState is not \"COMPLETE\"; no EndsAtPresentFlag provided for a potentially active collection.</li> </ul><b>Remediation:</b><br>If data collection is ongoing, provide an EndsAtPresentFlag of \"true\"", "Temporal/RangeDateTime/BeginningDateTime"=>"OK", "Temporal/SingleDateTime"=>"OK", "UseConstraints"=>"<b>Errors:</b><ul><li>Warning: No license information is provided.</li> </ul><b>Remediation:</b><br>Please provide information about the license applicable to the dataset, preferably as a URL. For EOSDIS records, please providing the following link (unless under different usage terms): https://earthdata.nasa.gov/earth-observation-data/data-use-policy", "Visible"=>"OK"}
        assert_equal(comment_hash, expected)
      end
    end

    it "returns results of the automated collection_script for dif10" do
      stub_request(:get, "https://cmr.sit.earthdata.nasa.gov/search/concepts/metric1-PODAAC.dif10").
        with(
          headers: {
            'Accept'=>'*/*',
            'Accept-Encoding'=>'gzip;q=1.0,deflate;q=0.6,identity;q=0.3',
            'User-Agent'=>'Ruby'
          }).
        to_return(status: 200, body: DIF10_RECORD, headers: {})

      stub_request(:post, "https://quarc.nasa-impact.net/validate").
        with(
          body: "{\"data\":{\"format\":\"dif10\"},\"files\":{\"file\":\"\\u003cDIF xmlns=\\\"http://gcmd.gsfc.nasa.gov/Aboutus/xml/dif/\\\" xmlns:dif=\\\"http://gcmd.gsfc.nasa.gov/Aboutus/xml/dif/\\\" xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xsi:schemaLocation=\\\"http://gcmd.gsfc.nasa.gov/Aboutus/xml/dif/ http://gcmd.gsfc.nasa.gov/Aboutus/xml/dif/dif_v10.2.xsd\\\"\\u003e\\u003cEntry_ID\\u003e\\u003cShort_Name\\u003eASAC_2201_HCL_0.5\\u003c/Short_Name\\u003e\\u003cVersion\\u003e1\\u003c/Version\\u003e\\u003c/Entry_ID\\u003e\\u003cEntry_Title\\u003e0.5 hour 1 M HCl extraction data for the Windmill Islands marine sediments\\u003c/Entry_Title\\u003e\\u003cDataset_Citation\\u003e\\u003cDataset_Creator\\u003eSnape, I., Riddle, M.J., Gore, D., Stark, J.S., Scouller, R. and Stark, S.C.\\u003c/Dataset_Creator\\u003e\\u003cDataset_Title\\u003e0.5 hour 1 M HCl extraction data for the Windmill Islands marine sediments\\u003c/Dataset_Title\\u003e\\u003cDataset_Series_Name\\u003eCAASM Metadata\\u003c/Dataset_Series_Name\\u003e\\u003cDataset_Release_Date\\u003e2004-08-02T00:00:00.000Z\\u003c/Dataset_Release_Date\\u003e\\u003cDataset_Publisher\\u003eAustralian Antarctic Data Centre\\u003c/Dataset_Publisher\\u003e\\u003cVersion\\u003e1\\u003c/Version\\u003e\\u003cPersistent_Identifier\\u003e\\u003cType\\u003eDOI\\u003c/Type\\u003e\\u003cIdentifier\\u003edoi:10.4225/15/5747A30D1F767\\u003c/Identifier\\u003e\\u003c/Persistent_Identifier\\u003e\\u003cOnline_Resource\\u003ehttps://data.aad.gov.au/metadata/records/ASAC_2201_HCL_0.5\\u003c/Online_Resource\\u003e\\u003c/Dataset_Citation\\u003e\\u003cPersonnel\\u003e\\u003cRole\\u003eINVESTIGATOR\\u003c/Role\\u003e\\u003cRole\\u003eTECHNICAL CONTACT\\u003c/Role\\u003e\\u003cContact_Person\\u003e\\u003cFirst_Name\\u003eIAN\\u003c/First_Name\\u003e\\u003cLast_Name\\u003eSNAPE\\u003c/Last_Name\\u003e\\u003cAddress\\u003e\\u003cStreet_Address\\u003eAustralian Antarctic Division\\u003c/Street_Address\\u003e\\u003cStreet_Address\\u003e203 Channel Highway\\u003c/Street_Address\\u003e\\u003cCity\\u003eKingston\\u003c/City\\u003e\\u003cState_Province\\u003eTasmania\\u003c/State_Province\\u003e\\u003cPostal_Code\\u003e7050\\u003c/Postal_Code\\u003e\\u003cCountry\\u003eAustralia\\u003c/Country\\u003e\\u003c/Address\\u003e\\u003cPhone\\u003e\\u003cNumber\\u003e+61 3 6232 3158\\u003c/Number\\u003e\\u003cType\\u003eFax\\u003c/Type\\u003e\\u003c/Phone\\u003e\\u003cPhone\\u003e\\u003cNumber\\u003e+61 3 6232 3591\\u003c/Number\\u003e\\u003cType\\u003eTelephone\\u003c/Type\\u003e\\u003c/Phone\\u003e\\u003cEmail\\u003eian.snape@aad.gov.au\\u003c/Email\\u003e\\u003c/Contact_Person\\u003e\\u003c/Personnel\\u003e\\u003cPersonnel\\u003e\\u003cRole\\u003eINVESTIGATOR\\u003c/Role\\u003e\\u003cContact_Person\\u003e\\u003cFirst_Name\\u003eMARTIN\\u003c/First_Name\\u003e\\u003cMiddle_Name\\u003eJ.\\u003c/Middle_Name\\u003e\\u003cLast_Name\\u003eRIDDLE\\u003c/Last_Name\\u003e\\u003cAddress\\u003e\\u003cStreet_Address\\u003eAustralian Antarctic Division\\u003c/Street_Address\\u003e\\u003cStreet_Address\\u003e203 Channel Highway\\u003c/Street_Address\\u003e\\u003cCity\\u003eKingston\\u003c/City\\u003e\\u003cState_Province\\u003eTasmania\\u003c/State_Province\\u003e\\u003cPostal_Code\\u003e7050\\u003c/Postal_Code\\u003e\\u003cCountry\\u003eAustralia\\u003c/Country\\u003e\\u003c/Address\\u003e\\u003cPhone\\u003e\\u003cNumber\\u003e+61 3 6232 3351\\u003c/Number\\u003e\\u003cType\\u003eFax\\u003c/Type\\u003e\\u003c/Phone\\u003e\\u003cPhone\\u003e\\u003cNumber\\u003e+61 3 6232 3573\\u003c/Number\\u003e\\u003cType\\u003eTelephone\\u003c/Type\\u003e\\u003c/Phone\\u003e\\u003cEmail\\u003emartin.riddle@aad.gov.au\\u003c/Email\\u003e\\u003c/Contact_Person\\u003e\\u003c/Personnel\\u003e\\u003cPersonnel\\u003e\\u003cRole\\u003eMETADATA AUTHOR\\u003c/Role\\u003e\\u003cContact_Person\\u003e\\u003cFirst_Name\\u003eDAVE\\u003c/First_Name\\u003e\\u003cMiddle_Name\\u003eJ.\\u003c/Middle_Name\\u003e\\u003cLast_Name\\u003eCONNELL\\u003c/Last_Name\\u003e\\u003cAddress\\u003e\\u003cStreet_Address\\u003eAustralian Antarctic Division\\u003c/Street_Address\\u003e\\u003cStreet_Address\\u003e203 Channel Highway\\u003c/Street_Address\\u003e\\u003cCity\\u003eKingston\\u003c/City\\u003e\\u003cState_Province\\u003eTasmania\\u003c/State_Province\\u003e\\u003cPostal_Code\\u003e7050\\u003c/Postal_Code\\u003e\\u003cCountry\\u003eAustralia\\u003c/Country\\u003e\\u003c/Address\\u003e\\u003cPhone\\u003e\\u003cNumber\\u003e+61 3 6232 3351\\u003c/Number\\u003e\\u003cType\\u003eFax\\u003c/Type\\u003e\\u003c/Phone\\u003e\\u003cPhone\\u003e\\u003cNumber\\u003e+61 3 6232 3244\\u003c/Number\\u003e\\u003cType\\u003eTelephone\\u003c/Type\\u003e\\u003c/Phone\\u003e\\u003cEmail\\u003edave.connell@aad.gov.au\\u003c/Email\\u003e\\u003c/Contact_Person\\u003e\\u003c/Personnel\\u003e\\u003cPersonnel\\u003e\\u003cRole\\u003eINVESTIGATOR\\u003c/Role\\u003e\\u003cContact_Person\\u003e\\u003cFirst_Name\\u003eDAMIAN\\u003c/First_Name\\u003e\\u003cLast_Name\\u003eGORE\\u003c/Last_Name\\u003e\\u003cAddress\\u003e\\u003cStreet_Address\\u003eDepartment of Physical Geography\\u003c/Street_Address\\u003e\\u003cStreet_Address\\u003eMacquarie University\\u003c/Street_Address\\u003e\\u003cCity\\u003eMarsfield\\u003c/City\\u003e\\u003cState_Province\\u003eNew South Wales\\u003c/State_Province\\u003e\\u003cPostal_Code\\u003e2109\\u003c/Postal_Code\\u003e\\u003cCountry\\u003eAustralia\\u003c/Country\\u003e\\u003c/Address\\u003e\\u003cPhone\\u003e\\u003cNumber\\u003e+61 2 9850 8420\\u003c/Number\\u003e\\u003cType\\u003eFax\\u003c/Type\\u003e\\u003c/Phone\\u003e\\u003cPhone\\u003e\\u003cNumber\\u003e+61 2 9850 8391\\u003c/Number\\u003e\\u003cType\\u003eTelephone\\u003c/Type\\u003e\\u003c/Phone\\u003e\\u003cEmail\\u003edamian.gore@mq.edu.au\\u003c/Email\\u003e\\u003c/Contact_Person\\u003e\\u003c/Personnel\\u003e\\u003cPersonnel\\u003e\\u003cRole\\u003eINVESTIGATOR\\u003c/Role\\u003e\\u003cContact_Person\\u003e\\u003cFirst_Name\\u003eJONATHAN\\u003c/First_Name\\u003e\\u003cMiddle_Name\\u003eSEAN\\u003c/Middle_Name\\u003e\\u003cLast_Name\\u003eSTARK\\u003c/Last_Name\\u003e\\u003cAddress\\u003e\\u003cStreet_Address\\u003eAustralian Antarctic Division\\u003c/Street_Address\\u003e\\u003cStreet_Address\\u003e203 Channel Highway\\u003c/Street_Address\\u003e\\u003cCity\\u003eKingston\\u003c/City\\u003e\\u003cState_Province\\u003eTasmania\\u003c/State_Province\\u003e\\u003cPostal_Code\\u003e7050\\u003c/Postal_Code\\u003e\\u003cCountry\\u003eAustralia\\u003c/Country\\u003e\\u003c/Address\\u003e\\u003cPhone\\u003e\\u003cNumber\\u003e+61 3 6232 3158\\u003c/Number\\u003e\\u003cType\\u003eFax\\u003c/Type\\u003e\\u003c/Phone\\u003e\\u003cPhone\\u003e\\u003cNumber\\u003e+61 3 6232 3589\\u003c/Number\\u003e\\u003cType\\u003eTelephone\\u003c/Type\\u003e\\u003c/Phone\\u003e\\u003cEmail\\u003ejonny.stark@aad.gov.au\\u003c/Email\\u003e\\u003c/Contact_Person\\u003e\\u003c/Personnel\\u003e\\u003cPersonnel\\u003e\\u003cRole\\u003eINVESTIGATOR\\u003c/Role\\u003e\\u003cRole\\u003eTECHNICAL CONTACT\\u003c/Role\\u003e\\u003cContact_Person\\u003e\\u003cFirst_Name\\u003eREBECCA\\u003c/First_Name\\u003e\\u003cLast_Name\\u003eSCOULLER\\u003c/Last_Name\\u003e\\u003cAddress\\u003e\\u003cStreet_Address\\u003eAustralian Antarctic Division\\u003c/Street_Address\\u003e\\u003cStreet_Address\\u003e203 Channel Highway\\u003c/Street_Address\\u003e\\u003cCity\\u003eKingston\\u003c/City\\u003e\\u003cState_Province\\u003eTasmania\\u003c/State_Province\\u003e\\u003cPostal_Code\\u003e7050\\u003c/Postal_Code\\u003e\\u003cCountry\\u003eAustralia\\u003c/Country\\u003e\\u003c/Address\\u003e\\u003cEmail\\u003ebeck.scouller@aad.gov.au\\u003c/Email\\u003e\\u003c/Contact_Person\\u003e\\u003c/Personnel\\u003e\\u003cPersonnel\\u003e\\u003cRole\\u003eINVESTIGATOR\\u003c/Role\\u003e\\u003cContact_Person\\u003e\\u003cFirst_Name\\u003eSCOTT\\u003c/First_Name\\u003e\\u003cMiddle_Name\\u003eCHARLES\\u003c/Middle_Name\\u003e\\u003cLast_Name\\u003eSTARK\\u003c/Last_Name\\u003e\\u003cAddress\\u003e\\u003cStreet_Address\\u003eAustralian Antarctic Division\\u003c/Street_Address\\u003e\\u003cStreet_Address\\u003e203 Channel Highway\\u003c/Street_Address\\u003e\\u003cCity\\u003eKingston\\u003c/City\\u003e\\u003cState_Province\\u003eTasmania\\u003c/State_Province\\u003e\\u003cPostal_Code\\u003e7050\\u003c/Postal_Code\\u003e\\u003cCountry\\u003eAustralia\\u003c/Country\\u003e\\u003c/Address\\u003e\\u003cPhone\\u003e\\u003cNumber\\u003e+61 3 6232 3351\\u003c/Number\\u003e\\u003cType\\u003eFax\\u003c/Type\\u003e\\u003c/Phone\\u003e\\u003cPhone\\u003e\\u003cNumber\\u003e+61 3 6232 3169\\u003c/Number\\u003e\\u003cType\\u003eTelephone\\u003c/Type\\u003e\\u003c/Phone\\u003e\\u003cEmail\\u003escott.stark@aad.gov.au\\u003c/Email\\u003e\\u003c/Contact_Person\\u003e\\u003c/Personnel\\u003e\\u003cScience_Keywords\\u003e\\u003cCategory\\u003eEARTH SCIENCE\\u003c/Category\\u003e\\u003cTopic\\u003eHUMAN DIMENSIONS\\u003c/Topic\\u003e\\u003cTerm\\u003eENVIRONMENTAL IMPACTS\\u003c/Term\\u003e\\u003cVariable_Level_1\\u003eHEAVY METALS CONCENTRATION\\u003c/Variable_Level_1\\u003e\\u003c/Science_Keywords\\u003e\\u003cScience_Keywords\\u003e\\u003cCategory\\u003eEARTH SCIENCE\\u003c/Category\\u003e\\u003cTopic\\u003eOCEANS\\u003c/Topic\\u003e\\u003cTerm\\u003eMARINE SEDIMENTS\\u003c/Term\\u003e\\u003c/Science_Keywords\\u003e\\u003cScience_Keywords\\u003e\\u003cCategory\\u003eEARTH SCIENCE\\u003c/Category\\u003e\\u003cTopic\\u003eOCEANS\\u003c/Topic\\u003e\\u003cTerm\\u003eMARINE SEDIMENTS\\u003c/Term\\u003e\\u003cVariable_Level_1\\u003eSEDIMENT CHEMISTRY\\u003c/Variable_Level_1\\u003e\\u003c/Science_Keywords\\u003e\\u003cISO_Topic_Category\\u003eENVIRONMENT\\u003c/ISO_Topic_Category\\u003e\\u003cISO_Topic_Category\\u003eGEOSCIENTIFIC INFORMATION\\u003c/ISO_Topic_Category\\u003e\\u003cISO_Topic_Category\\u003eOCEANS\\u003c/ISO_Topic_Category\\u003e\\u003cAncillary_Keyword\\u003eANTIMONY\\u003c/Ancillary_Keyword\\u003e\\u003cAncillary_Keyword\\u003eARSENIC\\u003c/Ancillary_Keyword\\u003e\\u003cAncillary_Keyword\\u003eBIOAVAILABLE METALS\\u003c/Ancillary_Keyword\\u003e\\u003cAncillary_Keyword\\u003eCADMIUM\\u003c/Ancillary_Keyword\\u003e\\u003cAncillary_Keyword\\u003eCHROMIUM\\u003c/Ancillary_Keyword\\u003e\\u003cAncillary_Keyword\\u003eCOPPER\\u003c/Ancillary_Keyword\\u003e\\u003cAncillary_Keyword\\u003eIRON\\u003c/Ancillary_Keyword\\u003e\\u003cAncillary_Keyword\\u003eKINETICS\\u003c/Ancillary_Keyword\\u003e\\u003cAncillary_Keyword\\u003eLEAD\\u003c/Ancillary_Keyword\\u003e\\u003cAncillary_Keyword\\u003eLOCATION\\u003c/Ancillary_Keyword\\u003e\\u003cAncillary_Keyword\\u003eMANGANESE\\u003c/Ancillary_Keyword\\u003e\\u003cAncillary_Keyword\\u003eMESS\\u003c/Ancillary_Keyword\\u003e\\u003cAncillary_Keyword\\u003eMULTIVARIATE ANALYSIS\\u003c/Ancillary_Keyword\\u003e\\u003cAncillary_Keyword\\u003eNICKEL\\u003c/Ancillary_Keyword\\u003e\\u003cAncillary_Keyword\\u003ePACS\\u003c/Ancillary_Keyword\\u003e\\u003cAncillary_Keyword\\u003eREPLICATE\\u003c/Ancillary_Keyword\\u003e\\u003cAncillary_Keyword\\u003eSILVER\\u003c/Ancillary_Keyword\\u003e\\u003cAncillary_Keyword\\u003eSITE\\u003c/Ancillary_Keyword\\u003e\\u003cAncillary_Keyword\\u003eTIN\\u003c/Ancillary_Keyword\\u003e\\u003cAncillary_Keyword\\u003eWINDMILL ISLANDS\\u003c/Ancillary_Keyword\\u003e\\u003cAncillary_Keyword\\u003eZINC\\u003c/Ancillary_Keyword\\u003e\\u003cPlatform\\u003e\\u003cType\\u003eNot provided\\u003c/Type\\u003e\\u003cShort_Name\\u003eNot provided\\u003c/Short_Name\\u003e\\u003cInstrument\\u003e\\u003cShort_Name\\u003eSEDIMENT CORERS\\u003c/Short_Name\\u003e\\u003c/Instrument\\u003e\\u003c/Platform\\u003e\\u003cPlatform\\u003e\\u003cType\\u003eNot provided\\u003c/Type\\u003e\\u003cShort_Name\\u003eLABORATORY\\u003c/Short_Name\\u003e\\u003cInstrument\\u003e\\u003cShort_Name\\u003eNot provided\\u003c/Short_Name\\u003e\\u003c/Instrument\\u003e\\u003c/Platform\\u003e\\u003cPlatform\\u003e\\u003cType\\u003eNot provided\\u003c/Type\\u003e\\u003cShort_Name\\u003eFIELD SURVEYS\\u003c/Short_Name\\u003e\\u003cInstrument\\u003e\\u003cShort_Name\\u003eNot provided\\u003c/Short_Name\\u003e\\u003c/Instrument\\u003e\\u003c/Platform\\u003e\\u003cTemporal_Coverage\\u003e\\u003cRange_DateTime\\u003e\\u003cBeginning_Date_Time\\u003e1997-10-01T00:00:00.000Z\\u003c/Beginning_Date_Time\\u003e\\u003cEnding_Date_Time\\u003e1999-03-31T23:59:59.999Z\\u003c/Ending_Date_Time\\u003e\\u003c/Range_DateTime\\u003e\\u003c/Temporal_Coverage\\u003e\\u003cDataset_Progress\\u003eCOMPLETE\\u003c/Dataset_Progress\\u003e\\u003cSpatial_Coverage\\u003e\\u003cSpatial_Coverage_Type\\u003eHorizontal\\u003c/Spatial_Coverage_Type\\u003e\\u003cGranule_Spatial_Representation\\u003eNO_SPATIAL\\u003c/Granule_Spatial_Representation\\u003e\\u003cGeometry\\u003e\\u003cCoordinate_System\\u003eCARTESIAN\\u003c/Coordinate_System\\u003e\\u003cBounding_Rectangle\\u003e\\u003cSouthernmost_Latitude\\u003e-66.0\\u003c/Southernmost_Latitude\\u003e\\u003cNorthernmost_Latitude\\u003e-66.0\\u003c/Northernmost_Latitude\\u003e\\u003cWesternmost_Longitude\\u003e110.0\\u003c/Westernmost_Longitude\\u003e\\u003cEasternmost_Longitude\\u003e110.0\\u003c/Easternmost_Longitude\\u003e\\u003c/Bounding_Rectangle\\u003e\\u003c/Geometry\\u003e\\u003cSpatial_Info\\u003e\\u003cSpatial_Coverage_Type\\u003eNot provided\\u003c/Spatial_Coverage_Type\\u003e\\u003c/Spatial_Info\\u003e\\u003c/Spatial_Coverage\\u003e\\u003cLocation\\u003e\\u003cLocation_Category\\u003eCONTINENT\\u003c/Location_Category\\u003e\\u003cLocation_Type\\u003eANTARCTICA\\u003c/Location_Type\\u003e\\u003cDetailed_Location\\u003eWindmill Islands\\u003c/Detailed_Location\\u003e\\u003c/Location\\u003e\\u003cLocation\\u003e\\u003cLocation_Category\\u003eGEOGRAPHIC REGION\\u003c/Location_Category\\u003e\\u003cLocation_Type\\u003ePOLAR\\u003c/Location_Type\\u003e\\u003c/Location\\u003e\\u003cProject\\u003e\\u003cShort_Name\\u003eNot provided\\u003c/Short_Name\\u003e\\u003c/Project\\u003e\\u003cQuality\\u003eThe dates provided in temporal coverage are approximate only.  Years are correct.\\n\\nSee the referenced paper for full details on steps taken to ensure quality of data.\\n\\nTo assess extraction efficiency for a range of sediment types, four marine sediments were analysed in detail.  Two international certified reference materials (CRMs) and two well-characterised Antarctic sediments were chosen to compare and contrast moderately to strongly contaminated samples (based on total metal digest), with clean samples of similar matrices.  One CRM was an uncontaminated continental shelf mud (MESS-2), and the other a contaminated harbour mud (PACS-2) (NRCC, 2002).  The two Antarctic sediments were collected as part of a regional hierarchical survey (Stark et al., 2003).  One Antarctic sample was from an area of known metal pollution in Brown Bay (BB), which is adjacent to the 'Old' Casey Station waste disposal site (Snape et al., 2001; Stark et al., 2003).  The second Antarctic sample was from a non-impacted control site from O'Brien Bay (OBB), 3 km south of Casey Station and the disposal site (Fig. 1).  The Antarctic samples, OBB and BB, have similar matrices, proportions of mud (less than 63 microns; 19% and 22% respectively) and total organic carbon contents (1.9% and 2.3% respectively). Both MESS and PACS are sieved, homogenised and dried CRMs that have been ground to ~50 microns (NRCC, 2002).  In contrast, OBB and BB were only sieved to less than 2 mm, thereby removing only the very largest particles (less than or equal to 3%).  The Antarctic samples were collected using acid-washed PVC coring tubes.  The samples were kept frozen at -20 degrees C until wet-sieved with a small amount of clean filtered (0.45 microns cellulose nitrate) O'Brien Bay seawater through 2 mm nylon mesh held in a plastic sieve unit.  The sediments were then oven-dried to constant weight at 103 degrees C (Loring and Rantala 1992), and stored in Nalgene HDPE bottles until analysis.\\u003c/Quality\\u003e\\u003cAccess_Constraints\\u003eThe data are available for download from the url given below.\\u003c/Access_Constraints\\u003e\\u003cUse_Constraints\\u003e\\u003cDescription\\u003eThis data set conforms to the CCBY Attribution License\\n(http://creativecommons.org/licenses/by/4.0/).\\n\\nPlease follow instructions listed in the citation reference provided at http://data.aad.gov.au/aadc/metadata/citation.cfm?entry_id=ASAC_2201_HCL_0.5 when using these data.\\u003c/Description\\u003e\\u003c/Use_Constraints\\u003e\\u003cDataset_Language\\u003eEnglish\\u003c/Dataset_Language\\u003e\\u003cOrganization\\u003e\\u003cOrganization_Type\\u003eARCHIVER\\u003c/Organization_Type\\u003e\\u003cOrganization_Type\\u003eDISTRIBUTOR\\u003c/Organization_Type\\u003e\\u003cOrganization_Name\\u003e\\u003cShort_Name\\u003eAU/AADC\\u003c/Short_Name\\u003e\\u003cLong_Name\\u003eAustralian Antarctic Data Centre, Australia\\u003c/Long_Name\\u003e\\u003c/Organization_Name\\u003e\\u003cOrganization_URL\\u003ehttp://data.aad.gov.au\\u003c/Organization_URL\\u003e\\u003cPersonnel\\u003e\\u003cRole\\u003eDATA CENTER CONTACT\\u003c/Role\\u003e\\u003cContact_Person\\u003e\\u003cFirst_Name\\u003eDATA OFFICER\\u003c/First_Name\\u003e\\u003cLast_Name\\u003eAADC\\u003c/Last_Name\\u003e\\u003cAddress\\u003e\\u003cStreet_Address\\u003eAustralian Antarctic Division\\u003c/Street_Address\\u003e\\u003cStreet_Address\\u003e203 Channel Highway\\u003c/Street_Address\\u003e\\u003cCity\\u003eKingston\\u003c/City\\u003e\\u003cState_Province\\u003eTasmania\\u003c/State_Province\\u003e\\u003cPostal_Code\\u003e7050\\u003c/Postal_Code\\u003e\\u003cCountry\\u003eAustralia\\u003c/Country\\u003e\\u003c/Address\\u003e\\u003cPhone\\u003e\\u003cNumber\\u003e+61 3 6232 3351\\u003c/Number\\u003e\\u003cType\\u003eFax\\u003c/Type\\u003e\\u003c/Phone\\u003e\\u003cPhone\\u003e\\u003cNumber\\u003e+61 3 6232 3244\\u003c/Number\\u003e\\u003cType\\u003eTelephone\\u003c/Type\\u003e\\u003c/Phone\\u003e\\u003cEmail\\u003emetadata@aad.gov.au\\u003c/Email\\u003e\\u003c/Contact_Person\\u003e\\u003c/Personnel\\u003e\\u003c/Organization\\u003e\\u003cReference\\u003e\\u003cAuthor\\u003eSnape, I., Scouller, R.C., Stark, S.C., Stark, J., Riddle, M.J., Gore, D.B.\\u003c/Author\\u003e\\u003cPublication_Date\\u003e2004-01-01T00:00:00.000Z\\u003c/Publication_Date\\u003e\\u003cTitle\\u003eCharacterisation of the dilute HCl extraction method for the identification of metal contamination in Antarctic marine sediments\\u003c/Title\\u003e\\u003cSeries\\u003eChemosphere\\u003c/Series\\u003e\\u003cVolume\\u003e57\\u003c/Volume\\u003e\\u003cIssue\\u003e6\\u003c/Issue\\u003e\\u003cPages\\u003e491-504\\u003c/Pages\\u003e\\u003cPersistent_Identifier\\u003e\\u003cType\\u003eDOI\\u003c/Type\\u003e\\u003cIdentifier\\u003edoi:10.1016/j.chemosphere.2004.05.042\\u003c/Identifier\\u003e\\u003c/Persistent_Identifier\\u003e\\u003c/Reference\\u003e\\u003cSummary\\u003e\\u003cAbstract\\u003eThese results are for the 0.5 hour extraction of HCl.\\n\\nSee also the metadata records for the 4 hour extraction of HCl, and the time trial data for 1 M HCl extractions.\\n\\nA regional survey of potential contaminants in marine or estuarine sediments is often one of the first steps in a post-disturbance environmental impact assessment. Of the many different chemical extraction or digestion procedures that have been proposed to quantify metal contamination, partial acid extractions are probably the best overall compromise between selectivity, sensitivity, precision, cost and expediency.  The extent to which measured metal concentrations relate to the anthropogenic fraction that is bioavailable is contentious, but is one of the desired outcomes of an assessment or prediction of biological impact.  As part of a regional survey of metal contamination associated with Australia's past waste management activities in Antarctica, we wanted to identify an acid type and extraction protocol that would allow a reasonable definition of the anthropogenic bioavailable fraction for a large number of samples.  From a kinetic study of the 1 M HCl extraction of two certified Certified Reference Materials (MESS-2 and PACS-2) and two Antarctic marine sediments, we concluded that a 4 hour extraction time allows the equilibrium dissolution of relatively labile metal contaminants, but does not favour the extraction of natural geogenic metals.  In a regional survey of 88 marine samples from the Casey Station area of East Antarctica, the 4 h extraction procedure correlated best with biological data, and most clearly identified those sediments thought to be contaminated by runoff from abandoned waste disposal sites.  Most importantly the 4 hour extraction provided better definition of the low to moderately contaminated locations by picking up small differences in anthropogenic metal concentrations.  For the purposes of inter-regional comparison, we recommend a 4 hour 1 M HCl acid extraction as a standard method for assessing metal contamination in Antarctica.\\n\\nThe fields in this dataset are\\n\\nLocation\\nSite\\nReplicate\\nAntimony\\nArsenic\\nCadmium\\nChromium\\nCopper\\nIron\\nLead\\nManganese\\nNickel\\nSilver\\nTin\\nZinc\\u003c/Abstract\\u003e\\u003c/Summary\\u003e\\u003cRelated_URL\\u003e\\u003cURL_Content_Type\\u003e\\u003cType\\u003eGET DATA\\u003c/Type\\u003e\\u003c/URL_Content_Type\\u003e\\u003cURL\\u003ehttp://data.aad.gov.au/aadc/portal/download_file.cfm?file_id=1677\\u003c/URL\\u003e\\u003cDescription\\u003eDownload point for the data\\u003c/Description\\u003e\\u003c/Related_URL\\u003e\\u003cRelated_URL\\u003e\\u003cURL_Content_Type\\u003e\\u003cType\\u003ePROJECT HOME PAGE\\u003c/Type\\u003e\\u003c/URL_Content_Type\\u003e\\u003cURL\\u003ehttps://secure3.aad.gov.au/proms/public/projects/report_project_public.cfm?project_no=2201\\u003c/URL\\u003e\\u003cDescription\\u003ePublic information for ASAC project 2201\\u003c/Description\\u003e\\u003c/Related_URL\\u003e\\u003cRelated_URL\\u003e\\u003cURL_Content_Type\\u003e\\u003cType\\u003eVIEW RELATED INFORMATION\\u003c/Type\\u003e\\u003c/URL_Content_Type\\u003e\\u003cURL\\u003ehttp://data.aad.gov.au/aadc/metadata/citation.cfm?entry_id=ASAC_2201_HCL_0.5\\u003c/URL\\u003e\\u003cDescription\\u003eCitation reference for this metadata record and dataset\\u003c/Description\\u003e\\u003c/Related_URL\\u003e\\u003cIDN_Node\\u003e\\u003cShort_Name\\u003eAMD/AU\\u003c/Short_Name\\u003e\\u003c/IDN_Node\\u003e\\u003cIDN_Node\\u003e\\u003cShort_Name\\u003eCEOS\\u003c/Short_Name\\u003e\\u003c/IDN_Node\\u003e\\u003cIDN_Node\\u003e\\u003cShort_Name\\u003eAMD\\u003c/Short_Name\\u003e\\u003c/IDN_Node\\u003e\\u003cMetadata_Name\\u003eCEOS IDN DIF\\u003c/Metadata_Name\\u003e\\u003cMetadata_Version\\u003eVERSION 10.2\\u003c/Metadata_Version\\u003e\\u003cMetadata_Dates\\u003e\\u003cMetadata_Creation\\u003e2004-07-30\\u003c/Metadata_Creation\\u003e\\u003cMetadata_Last_Revision\\u003e2017-04-26\\u003c/Metadata_Last_Revision\\u003e\\u003cData_Creation\\u003e1970-01-01T00:00:00\\u003c/Data_Creation\\u003e\\u003cData_Last_Revision\\u003e1970-01-01T00:00:00\\u003c/Data_Last_Revision\\u003e\\u003c/Metadata_Dates\\u003e\\u003cProduct_Level_Id\\u003eNot provided\\u003c/Product_Level_Id\\u003e\\u003c/DIF\\u003e\"}}",
          headers: {
            'Accept'=>'*/*',
            'Accept-Encoding'=>'gzip;q=1.0,deflate;q=0.6,identity;q=0.3',
            'Content-Type'=>'application/json',
            'User-Agent'=>'Faraday v1.4.1'
          }).
        to_return(status: 200, body: "{}", headers: {})

      record = records(:metric1)

      Quarc.stub_any_instance(:validate, {"AdditionalAttributes/AdditionalAttribute/DataType"=>"OK", "AdditionalAttributes/AdditionalAttribute/Value"=>"doi_link_update failed<br>", "ArchiveCenter"=>"<b>Errors:</b><ul><li>Error: The provided data center short name `GHRC` does not comply with the GCMD. </li> </ul><b>Remediation:</b><br>Please submit a request to support@earthdata.nasa.gov to have this provider added to the GCMD Providers KMS.", "Campaigns/Campaign/ShortName"=>"OK", "CitationforExternalPublication"=>"<b>Errors:</b><ul><li>Warning: No CitationforExternalPublication is provided.</li> </ul><b>Remediation:</b><br>Please provide a citation for the dataset in the CitationforExternalPublication field.", "CollectionDataType"=>"OK", "Contacts/Contact/Role"=>"<b>Errors:</b><ul><li>Error: `['GHRC USER SERVICES']` is not a valid Contact Role.</li> </ul><b>Remediation:</b><br>Select a Contact Role from the following list: ['ARCHIVER', 'DISTRIBUTOR', 'PROCESSOR', 'ORIGINATOR'].", "DOI/Explanation"=>"OK", "DataSetId"=>"OK", "Description"=>"OK", "InsertTime"=>"OK", "LastUpdate"=>"OK", "OnlineResources/OnlineResource/MimeType"=>"OK", "OnlineResources/OnlineResource/Type"=>"<b>Errors:</b><ul><li>Error: Online Resource Type `Alternate Data Access` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `Browse` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `Worldview Imagery` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `Homepage` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `Guide` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `DOI` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `Citing GHRC Data` is not consistent with GCMD 'rucontenttype' list.</li> </ul><b>Remediation:</b><br>Please provide a GCMD compliant Online Resource Type.", "Orderable"=>"OK", "Platforms/Platform/Characteristics/Characteristic/DataType"=>"OK", "Platforms/Platform/Characteristics/Characteristic/Description"=>"OK", "Platforms/Platform/Characteristics/Characteristic/Name"=>"OK", "Platforms/Platform/Characteristics/Characteristic/Unit"=>"OK", "Platforms/Platform/Characteristics/Characteristic/Value"=>"OK", "Platforms/Platform/Instruments/Instrument/Characteristics/Characteristic/DataType"=>"OK", "Platforms/Platform/Instruments/Instrument/Characteristics/Characteristic/Description"=>"OK", "Platforms/Platform/Instruments/Instrument/Characteristics/Characteristic/Name"=>"OK", "Platforms/Platform/Instruments/Instrument/Characteristics/Characteristic/Unit"=>"OK", "Platforms/Platform/Instruments/Instrument/Characteristics/Characteristic/Value"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/Characteristics/Characteristic/DataType"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/Characteristics/Characteristic/Description"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/Characteristics/Characteristic/Name"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/Characteristics/Characteristic/Unit"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/Characteristics/Characteristic/Value"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/ShortName"=>"OK", "Platforms/Platform/Instruments/Instrument/ShortName"=>"OK", "Platforms/Platform/LongName"=>"<b>Errors:</b><ul><li>Error: The provided platform long name `GCOM-W1` does not comply with the GCMD.</li> </ul><b>Remediation:</b><br>Please submit a request to support@earthdata.nasa.gov to have this platform added to the GCMD Platform KMS.", "Platforms/Platform/Type"=>"<b>Errors:</b><ul><li>Error: The provided platform type `SATELLITE` does not comply with the GCMD.</li> </ul><b>Remediation:</b><br>Please submit a request to support@earthdata.nasa.gov to have this platform type added to the GCMD Platforms KMS.", "ProcessingLevelId"=>"OK", "ScienceKeywords/ScienceKeyword/CategoryKeyword"=>"OK", "Spatial/GranuleSpatialRepresentation"=>"OK", "Spatial/HorizontalSpatialDomain/Geometry/CoordinateSystem"=>"<b>Errors:</b><ul><li>Error: Missing child element(s). Expected is one of ( Point, BoundingRectangle, GPolygon, Line ).</li> </ul>schema failed<br>", "Spatial/HorizontalSpatialDomain/Geometry/Point"=>"<b>Errors:</b><ul><li>Info: No spatial extent is provided.</li> </ul><b>Remediation:</b><br>Please provide a spatial extent in one of the following form: Point, Bounding Rectangle, GPolygon, Line", "Spatial/SpatialCoverageType"=>"<b>Errors:</b><ul><li>Error: The Spatial Coverage Type provided `['Horizontal']` is invalid.</li> </ul><b>Remediation:</b><br>Please provide a Spatial Coverage Type from the following list: ['HORIZONTAL', 'VERTICAL', 'ORBITAL', 'HORIZONTAL_VERTICAL', ORBITAL_VERTICAL', 'HORIZONTAL_ORBITAL', 'HORIZONTAL_VERTICAL_ORBITAL']", "SpatialInfo/HorizontalCoordinateSystem/GeodeticModel/HorizontalDatumName"=>"<b>Errors:</b><ul><li>Info: Horizontal Datum Name is missing.</li> </ul><b>Remediation:</b><br>Please provide a Horizontal Datum Name.", "SpatialKeywords/Keyword"=>"OK", "Temporal/EndsAtPresentFlag"=>"<b>Errors:</b><ul><li>Warning: Potential issue with:\n - No EndingDateTime provided; no EndsAtPresentFlag provided for a potentially active collection. \n - CollectionState is not \"COMPLETE\"; no EndsAtPresentFlag provided for a potentially active collection.</li> </ul><b>Remediation:</b><br>If data collection is ongoing, provide an EndsAtPresentFlag of \"true\"", "Temporal/RangeDateTime/BeginningDateTime"=>"OK", "Temporal/SingleDateTime"=>"OK", "UseConstraints"=>"<b>Errors:</b><ul><li>Warning: No license information is provided.</li> </ul><b>Remediation:</b><br>Please provide information about the license applicable to the dataset, preferably as a URL. For EOSDIS records, please providing the following link (unless under different usage terms): https://earthdata.nasa.gov/earth-observation-data/data-use-policy", "Visible"=>"OK"}) do
        comment_hash = record.evaluate_script(nil)
        comment_hash = sort_by_key(comment_hash)

        expected = {"AdditionalAttributes/AdditionalAttribute/DataType"=>"OK", "AdditionalAttributes/AdditionalAttribute/Value"=>"doi_link_update failed<br>", "ArchiveCenter"=>"<b>Errors:</b><ul><li>Error: The provided data center short name `GHRC` does not comply with the GCMD. </li> </ul><b>Remediation:</b><br>Please submit a request to support@earthdata.nasa.gov to have this provider added to the GCMD Providers KMS.", "Campaigns/Campaign/ShortName"=>"OK", "CitationforExternalPublication"=>"<b>Errors:</b><ul><li>Warning: No CitationforExternalPublication is provided.</li> </ul><b>Remediation:</b><br>Please provide a citation for the dataset in the CitationforExternalPublication field.", "CollectionDataType"=>"OK", "Contacts/Contact/Role"=>"<b>Errors:</b><ul><li>Error: `['GHRC USER SERVICES']` is not a valid Contact Role.</li> </ul><b>Remediation:</b><br>Select a Contact Role from the following list: ['ARCHIVER', 'DISTRIBUTOR', 'PROCESSOR', 'ORIGINATOR'].", "DOI/Explanation"=>"OK", "DataSetId"=>"OK", "Description"=>"OK", "InsertTime"=>"OK", "LastUpdate"=>"OK", "OnlineResources/OnlineResource/MimeType"=>"OK", "OnlineResources/OnlineResource/Type"=>"<b>Errors:</b><ul><li>Error: Online Resource Type `Alternate Data Access` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `Browse` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `Worldview Imagery` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `Homepage` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `Guide` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `DOI` is not consistent with GCMD 'rucontenttype' list.</li> <li>Error: Online Resource Type `Citing GHRC Data` is not consistent with GCMD 'rucontenttype' list.</li> </ul><b>Remediation:</b><br>Please provide a GCMD compliant Online Resource Type.", "Orderable"=>"OK", "Platforms/Platform/Characteristics/Characteristic/DataType"=>"OK", "Platforms/Platform/Characteristics/Characteristic/Description"=>"OK", "Platforms/Platform/Characteristics/Characteristic/Name"=>"OK", "Platforms/Platform/Characteristics/Characteristic/Unit"=>"OK", "Platforms/Platform/Characteristics/Characteristic/Value"=>"OK", "Platforms/Platform/Instruments/Instrument/Characteristics/Characteristic/DataType"=>"OK", "Platforms/Platform/Instruments/Instrument/Characteristics/Characteristic/Description"=>"OK", "Platforms/Platform/Instruments/Instrument/Characteristics/Characteristic/Name"=>"OK", "Platforms/Platform/Instruments/Instrument/Characteristics/Characteristic/Unit"=>"OK", "Platforms/Platform/Instruments/Instrument/Characteristics/Characteristic/Value"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/Characteristics/Characteristic/DataType"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/Characteristics/Characteristic/Description"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/Characteristics/Characteristic/Name"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/Characteristics/Characteristic/Unit"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/Characteristics/Characteristic/Value"=>"OK", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/ShortName"=>"OK", "Platforms/Platform/Instruments/Instrument/ShortName"=>"OK", "Platforms/Platform/LongName"=>"<b>Errors:</b><ul><li>Error: The provided platform long name `GCOM-W1` does not comply with the GCMD.</li> </ul><b>Remediation:</b><br>Please submit a request to support@earthdata.nasa.gov to have this platform added to the GCMD Platform KMS.", "Platforms/Platform/Type"=>"<b>Errors:</b><ul><li>Error: The provided platform type `SATELLITE` does not comply with the GCMD.</li> </ul><b>Remediation:</b><br>Please submit a request to support@earthdata.nasa.gov to have this platform type added to the GCMD Platforms KMS.", "ProcessingLevelId"=>"OK", "ScienceKeywords/ScienceKeyword/CategoryKeyword"=>"OK", "Spatial/GranuleSpatialRepresentation"=>"OK", "Spatial/HorizontalSpatialDomain/Geometry/CoordinateSystem"=>"<b>Errors:</b><ul><li>Error: Missing child element(s). Expected is one of ( Point, BoundingRectangle, GPolygon, Line ).</li> </ul>schema failed<br>", "Spatial/HorizontalSpatialDomain/Geometry/Point"=>"<b>Errors:</b><ul><li>Info: No spatial extent is provided.</li> </ul><b>Remediation:</b><br>Please provide a spatial extent in one of the following form: Point, Bounding Rectangle, GPolygon, Line", "Spatial/SpatialCoverageType"=>"<b>Errors:</b><ul><li>Error: The Spatial Coverage Type provided `['Horizontal']` is invalid.</li> </ul><b>Remediation:</b><br>Please provide a Spatial Coverage Type from the following list: ['HORIZONTAL', 'VERTICAL', 'ORBITAL', 'HORIZONTAL_VERTICAL', ORBITAL_VERTICAL', 'HORIZONTAL_ORBITAL', 'HORIZONTAL_VERTICAL_ORBITAL']", "SpatialInfo/HorizontalCoordinateSystem/GeodeticModel/HorizontalDatumName"=>"<b>Errors:</b><ul><li>Info: Horizontal Datum Name is missing.</li> </ul><b>Remediation:</b><br>Please provide a Horizontal Datum Name.", "SpatialKeywords/Keyword"=>"OK", "Temporal/EndsAtPresentFlag"=>"<b>Errors:</b><ul><li>Warning: Potential issue with:\n - No EndingDateTime provided; no EndsAtPresentFlag provided for a potentially active collection. \n - CollectionState is not \"COMPLETE\"; no EndsAtPresentFlag provided for a potentially active collection.</li> </ul><b>Remediation:</b><br>If data collection is ongoing, provide an EndsAtPresentFlag of \"true\"", "Temporal/RangeDateTime/BeginningDateTime"=>"OK", "Temporal/SingleDateTime"=>"OK", "UseConstraints"=>"<b>Errors:</b><ul><li>Warning: No license information is provided.</li> </ul><b>Remediation:</b><br>Please provide information about the license applicable to the dataset, preferably as a URL. For EOSDIS records, please providing the following link (unless under different usage terms): https://earthdata.nasa.gov/earth-observation-data/data-use-policy", "Visible"=>"OK"}
        assert_equal(expected, comment_hash)
      end
    end

    it "returns results of the automated granule_script" do
      #manually setting the record as a granule so the evaluate script runs the write python script
      record = Record.find_by id: 5
      raw_data = JSON.parse("{\"ShortName\":\"CIESIN_SEDAC_NRMI_NRPCHI15\",\"VersionId\":\"2015.00\",\"InsertTime\":\"2016-11-02T00:00:00.000Z\",\"LastUpdate\":\"2016-11-02T00:00:00.000Z\",\"LongName\":\"Natural Resource Protection and Child Health Indicators, 2015 Release\",\"DataSetId\":\"Natural Resource Protection and Child Health Indicators, 2015 Release\",\"Description\":\"The Natural Resource Protection and Child Health Indicators, 2015 Release, are produced in support of the U.S. Millennium Challenge Corporation as selection criteria for funding eligibility. These indicators are successors to the Natural Resource Management Index (NRMI), which was produced from 2006 to 2011 and was based on the same underlying data. Like the NRMI, the Natural Resource Protection Indicator (NRPI) and Child Health Indicator (CHI) are based on proximity-to-target scores ranging from 0 to 100 (at target). The NRPI covers 221 countries and is calculated based on the weighted average percentage of biomes under protected status. The CHI is a composite index for 188 countries derived from the average of three proximity-to-target scores for access to improved sanitation, access to improved water, and child mortality. The 2015 release includes a consistent time series of NRPIs and CHIs for 2010 to 2015.\",\"CollectionDataType\":\"SCIENCE_QUALITY\",\"Orderable\":\"true\",\"Visible\":\"true\",\"RevisionDate\":\"2016-11-02T00:00:00.000Z\",\"ArchiveCenter\":\"SEDAC\",\"CollectionState\":\"Completed\",\"SpatialKeywords\":{\"Keyword\":[\"AFRICA\",\"ALGERIA\",\"ASIA\",\"AUSTRALIA\",\"BHUTAN\",\"BOTSWANA\",\"BURMA\",\"CAMBODIA\",\"CAMEROON\",\"CANADA\",\"CAPE VERDE\",\"CAYMAN ISLANDS\",\"CENTRAL AFRICAN REPUBLIC\",\"CHAD\",\"CHILE\",\"CHINA\",\"COLOMBIA\",\"COMOROS\",\"CONGO\",\"CONGO, DEMOCRATIC REPUBLIC\",\"COOK ISLANDS\",\"COSTA RICA\",\"COTE D'IVOIRE\",\"CROATIA\",\"CUBA\",\"CURACAO\",\"CYPRUS\",\"CZECH REPUBLIC\",\"DENMARK\",\"DJIBOUTI\",\"DOMINICA\",\"DOMINICAN REPUBLIC\",\"ECUADOR\",\"EGYPT\",\"EL SALVADOR\",\"EQUATORIAL\",\"EQUATORIAL GUINEA\",\"ERITREA\",\"ESTONIA\",\"ETHIOPIA\",\"EUROPE\",\"FAEROE ISLANDS\",\"FALKLAND ISLANDS\",\"FIJI\",\"FINLAND\",\"FRANCE\",\"FRENCH GUIANA\",\"FRENCH POLYNESIA\",\"GABON\",\"GAMBIA\",\"GEORGIA\",\"GERMANY\",\"GHANA\",\"GIBRALTAR\",\"GLOBAL\",\"GREECE\",\"GREENLAND\",\"GRENADA\",\"GUADELOUPE\",\"GUAM\",\"GUATEMALA\",\"GUINEA\",\"GUINEA-BISSAU\",\"GUYANA\",\"HAITI\",\"HONDURAS\",\"HONG KONG\",\"HUNGARY\",\"ICELAND\",\"INDIA\",\"INDONESIA\",\"IRAN\",\"IRAQ\",\"IRELAND\",\"ISLE OF MAN\",\"ISRAEL\",\"ITALY\",\"JAMAICA\",\"JAPAN\",\"JORDAN\",\"KAZAKHSTAN\",\"KENYA\",\"KIRIBATI\",\"KOSOVO\",\"KUWAIT\",\"KYRGYZSTAN\",\"LAO PEOPLE'S DEMOCRATIC REPUBLIC\",\"LATVIA\",\"LEBANON\",\"LESOTHO\",\"LIBERIA\",\"LIBYA\",\"LIECHTENSTEIN\",\"LITHUANIA\",\"LUXEMBOURG\",\"MACAU\",\"MACEDONIA\",\"MADAGASCAR\",\"MALAWI\",\"MALAYSIA\",\"MALDIVES\",\"MALI\",\"MALTA\",\"MARSHALL ISLANDS\",\"MARTINIQUE\",\"MAURITANIA\",\"MAURITIUS\",\"MAYOTTE\",\"MEXICO\",\"MICRONESIA\",\"MID-LATITUDE\",\"MOLDOVA\",\"MONACO\",\"MONGOLIA\",\"MONTENEGRO\",\"MONTSERRAT\",\"MOROCCO\",\"MOZAMBIQUE\",\"NAMIBIA\",\"NAURU\",\"NEPAL\",\"NETHERLANDS\",\"NEW CALEDONIA\",\"NEW ZEALAND\",\"NICARAGUA\",\"NIGER\",\"NIGERIA\",\"NIUE\",\"NORFOLK ISLAND\",\"NORTH AMERICA\",\"NORTH KOREA\",\"NORTHERN MARIANA ISLANDS\",\"NORWAY\",\"OMAN\",\"PAKISTAN\",\"PALAU\",\"PALESTINE\",\"PANAMA\",\"PAPUA NEW GUINEA\",\"PARAGUAY\",\"PERU\",\"PHILIPPINES\",\"PITCAIRN ISLANDS\",\"POLAND\",\"POLAR\",\"PORTUGAL\",\"PUERTO RICO\",\"QATAR\",\"REUNION\",\"ROMANIA\",\"RUSSIAN FEDERATION\",\"RWANDA\",\"SAMOA\",\"SAN MARINO\",\"SAO TOME AND PRINCIPE\",\"SAUDI ARABIA\",\"SENEGAL\",\"SERBIA\",\"SEYCHELLES\",\"SIERRA LEONE\",\"SINGAPORE\",\"SLOVAKIA\",\"SLOVENIA\",\"SOLOMON ISLANDS\",\"SOMALIA\",\"SOUTH AFRICA\",\"SOUTH AMERICA\",\"SOUTH KOREA\",\"SOUTH SUDAN\",\"SPAIN\",\"SRI LANKA\",\"ST HELENA\",\"ST KITTS AND NEVIS\",\"ST LUCIA\",\"ST MAARTEN\",\"ST MARTIN\",\"ST PIERRE AND MIQUELON\",\"ST VINCENT AND THE GRENADINES\",\"SUDAN\",\"SURINAME\",\"SVALBARD AND JAN MAYEN\",\"SWAZILAND\",\"SWEDEN\",\"SWITZERLAND\",\"SYRIAN ARAB REPUBLIC\",\"TAIWAN\",\"TAJIKISTAN\",\"TANZANIA\",\"THAILAND\",\"TIMOR-LESTE\",\"TOGO\",\"TOKELAU\",\"TONGA\",\"TRINIDAD AND TOBAGO\",\"TUNISIA\",\"TURKEY\",\"TURKMENISTAN\",\"TURKS AND CAICOS ISLANDS\",\"TUVALU\",\"UGANDA\",\"UKRAINE\",\"UNITED KINGDOM\",\"UNITED STATES OF AMERICA\",\"URUGUAY\",\"UZBEKISTAN\",\"VANUATU\",\"VENEZUELA\",\"VIETNAM\",\"VIRGIN ISLANDS\",\"WALLIS AND FUTUNA ISLANDS\",\"WESTERN SAHARA\",\"YEMEN\",\"ZAMBIA\",\"ZIMBABWE\"]},\"Temporal\":{\"RangeDateTime\":{\"BeginningDateTime\":\"2010-01-01T00:00:00.000Z\",\"EndingDateTime\":\"2015-12-31T23:59:59.999Z\"}},\"Contacts\":{\"Contact\":[{\"Role\":\"METADATA AUTHOR\",\"OrganizationEmails\":{\"Email\":\"metadata@ciesin.columbia.edu\"},\"ContactPersons\":{\"ContactPerson\":{\"FirstName\":\"unknown\",\"LastName\":\"CIESIN METADATA ADMINISTRATION\"}}},{\"Role\":\"TECHNICAL CONTACT\",\"OrganizationEmails\":{\"Email\":\"ciesin.info@ciesin.columbia.edu\"},\"ContactPersons\":{\"ContactPerson\":{\"FirstName\":\"unknown\",\"LastName\":\"SEDAC USER SERVICES\"}}}]},\"ScienceKeywords\":{\"ScienceKeyword\":[{\"CategoryKeyword\":\"EARTH SCIENCE\",\"TopicKeyword\":\"BIOSPHERE\",\"TermKeyword\":\"ECOLOGICAL DYNAMICS\",\"VariableLevel1Keyword\":{\"Value\":\"COMMUNITY DYNAMICS\",\"VariableLevel2Keyword\":{\"Value\":\"BIODIVERSITY FUNCTIONS\"}}},{\"CategoryKeyword\":\"EARTH SCIENCE\",\"TopicKeyword\":\"BIOSPHERE\",\"TermKeyword\":\"ECOSYSTEMS\",\"VariableLevel1Keyword\":{\"Value\":\"TERRESTRIAL ECOSYSTEMS\",\"VariableLevel2Keyword\":{\"Value\":\"ALPINE/TUNDRA\",\"VariableLevel3Keyword\":\"ALPINE TUNDRA\"}}},{\"CategoryKeyword\":\"EARTH SCIENCE\",\"TopicKeyword\":\"BIOSPHERE\",\"TermKeyword\":\"ECOSYSTEMS\",\"VariableLevel1Keyword\":{\"Value\":\"TERRESTRIAL ECOSYSTEMS\",\"VariableLevel2Keyword\":{\"Value\":\"FORESTS\"}}},{\"CategoryKeyword\":\"EARTH SCIENCE\",\"TopicKeyword\":\"HUMAN DIMENSIONS\",\"TermKeyword\":\"ENVIRONMENTAL IMPACTS\",\"VariableLevel1Keyword\":{\"Value\":\"CONSERVATION\"}},{\"CategoryKeyword\":\"EARTH SCIENCE\",\"TopicKeyword\":\"HUMAN DIMENSIONS\",\"TermKeyword\":\"SUSTAINABILITY\",\"VariableLevel1Keyword\":{\"Value\":\"ENVIRONMENTAL SUSTAINABILITY\"}}]},\"Platforms\":{\"Platform\":{\"ShortName\":\"NOT APPLICABLE\",\"LongName\":null,\"Type\":\"Not applicable\",\"Instruments\":{\"Instrument\":{\"ShortName\":\"NOT APPLICABLE\"}}}},\"Campaigns\":{\"Campaign\":{\"ShortName\":\"NRMI\",\"LongName\":\"Natural Resources Management Index\"}},\"OnlineAccessURLs\":{\"OnlineAccessURL\":{\"URL\":\"http://sedac.ciesin.columbia.edu/data/set/nrmi-natural-resource-protection-child-health-indicators-2015/data-download\",\"URLDescription\":\"Data landing page\"}},\"Spatial\":{\"HorizontalSpatialDomain\":{\"Geometry\":{\"CoordinateSystem\":\"CARTESIAN\",\"BoundingRectangle\":{\"WestBoundingCoordinate\":\"-180\",\"NorthBoundingCoordinate\":\"90\",\"EastBoundingCoordinate\":\"180\",\"SouthBoundingCoordinate\":\"-55\"}}},\"GranuleSpatialRepresentation\":\"CARTESIAN\"}}")
      comment_hash = record.evaluate_script(raw_data)
      comment_hash = sort_by_key(comment_hash)

      # #URL is removed to prevent this test fails when it is broken link
      comment_hash.delete("OnlineAccessURLs/OnlineAccessURL/URL")
      comment_hash.delete("OnlineResources/OnlineResource/URL")
      expect_str = %q{{"Campaigns/"=>"OK", "Collection/DataSetId"=>"np - Ensure that the ShortName and VersionId fields are provided.", "Collection/ShortName"=>"np - Ensure the DataSetId field is provided.", "Collection/VersionId"=>"np - Ensure the DataSetId field is provided.", "DataFormat"=>"Recommend providing the data format for the associated granule", "DataGranule/DayNightFlag"=>"np", "DataGranule/ProductionDateTime"=>"np", "DataGranule/SizeMBDataGranule"=>"Granule file size not provided. Recommend providing a value for this field in the metadata", "DeleteTime"=>"np", "InsertTime"=>"InsertTime error.", "LastUpdate"=>"np", "OnlineAccessURLs/OnlineAccessURL/URLDescription"=>"OK - quality check", "OnlineResource/OnlineResource/Description"=>"np", "OnlineResources/OnlineResource/Type"=>"np", "OrbitCalculatedSpatialDomains/OrbitCalculatedSpatialDomain/EquatorCrossingDateTime"=>"np", "Orderable"=>"Note: The Orderable field is being deprecated in UMM.", "Platforms/Platform/Instruments/Instrument/Sensors/Sensor/ShortName"=>"np", "Platforms/Platform/Instruments/Instrument/ShortName"=>"OK- quality check", "Platforms/Platform/ShortName"=>"NOT APPLICABLE: incorrect keyword order", "Spatial/HorizontalSpatialDomain/Geometry/BoundingRectangle"=>"OK - quality check, OK - quality check, OK - quality check, OK - quality check, ", "Temporal/RangeDateTime/BeginningDateTime"=>"BeginningDateTime error", "Temporal/RangeDateTime/EndingDateTime"=>"EndingDateTime error", "Temporal/RangeDateTime/SingleDateTime"=>"np", "Visible"=>"Note: The Visible field is being deprecated in UMM."}}
      assert_equal(expect_str, comment_hash.to_s)
    end

  end

  describe "daac scope" do
    it "will return records for the given DAAC" do
      records = Record.daac("PODAAC")
      assert_equal 15, records.length
    end

    it "will not return records that belong to anoter DAAC" do
      records = Record.daac("FakeDAAC")
      assert records.empty?
    end
  end

  describe "released_to_daac_date" do
    it "updates the record's released_to_daac_date when releasing" do
      record = Record.first
      assert_nil record.released_to_daac_date
      record.update_released_to_daac_date
      assert_in_delta record.released_to_daac_date, Time.zone.now, 10
    end

    it "removes the record's released_to_daac_date when reverting" do
      record = Record.first
      record.released_to_daac_date = Time.zone.now
      assert_not_nil record.released_to_daac_date
      record.remove_released_to_daac_date
      assert_nil record.released_to_daac_date
    end
  end
end
